<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SoBunSoBun - ì±„íŒ…</title>
    <script src="https://unpkg.com/@stomp/stompjs@7.1.0/bundles/stomp.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            color: #333;
        }

        .app-container {
            display: flex;
            height: 100vh;
        }

        /* ì¢Œì¸¡ íŒ¨ë„ - ì±„íŒ…ë°© ëª©ë¡ */
        .sidebar {
            width: 280px;
            background: #fff;
            border-right: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .sidebar-header h1 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .connection-status {
            display: flex;
            align-items: center;
            font-size: 12px;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }

        .status-indicator.connected {
            background: #4caf50;
        }

        .status-indicator.disconnected {
            background: #f44336;
            animation: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .room-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .room-item {
            padding: 12px;
            margin: 5px 0;
            background: #f9f9f9;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .room-item:hover {
            background: #f0f0f0;
            border-color: #667eea;
        }

        .room-item.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .room-item-name {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .room-item-desc {
            font-size: 12px;
            opacity: 0.7;
        }

        .sidebar-footer {
            padding: 15px;
            border-top: 1px solid #e0e0e0;
            display: grid;
            gap: 10px;
        }

        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-danger:hover {
            background: #da190b;
        }

        /* ìš°ì¸¡ íŒ¨ë„ - ì±„íŒ… */
        .chat-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
        }

        .chat-header {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header h2 {
            font-size: 18px;
            font-weight: 600;
            margin: 0;
        }

        .chat-header-info {
            font-size: 13px;
            opacity: 0.9;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            background: #f9f9f9;
        }

        .message-group {
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .message-group.own {
            justify-content: flex-end;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
            flex-shrink: 0;
        }

        .message-content {
            display: flex;
            flex-direction: column;
            gap: 4px;
            max-width: 70%;
        }

        .message-group.own .message-content {
            align-items: flex-end;
        }

        .message-sender {
            font-size: 12px;
            font-weight: 600;
            color: #555;
        }

        .message-text {
            padding: 10px 14px;
            border-radius: 8px;
            background: white;
            border: 1px solid #e0e0e0;
            word-wrap: break-word;
            font-size: 14px;
            line-height: 1.4;
        }

        .message-group.own .message-text {
            background: #667eea;
            color: white;
            border: none;
        }

        .message-time {
            font-size: 11px;
            color: #999;
        }

        .message-status {
            font-size: 11px;
            margin-left: 4px;
        }

        .no-messages {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #999;
        }

        .no-messages-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        /* ì…ë ¥ ì˜ì—­ */
        .message-input-area {
            padding: 20px;
            border-top: 1px solid #e0e0e0;
            background: white;
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .input-wrapper {
            flex: 1;
            display: flex;
            gap: 8px;
        }

        .message-input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            resize: none;
            max-height: 100px;
            transition: border-color 0.3s;
        }

        .message-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn-send {
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: background 0.3s;
        }

        .btn-send:hover:not(:disabled) {
            background: #5568d3;
        }

        .btn-send:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* ì„¤ì • ëª¨ë‹¬ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 400px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
        }

        .modal-body {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .form-group label {
            font-size: 13px;
            font-weight: 600;
            color: #555;
        }

        .form-group input, .form-group textarea {
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .modal-footer {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: flex-end;
        }

        .btn-cancel {
            background: #e0e0e0;
            color: #333;
        }

        .btn-cancel:hover {
            background: #d0d0d0;
        }

        /* ë¡œê·¸ */
        .log {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #1e1e1e;
            color: #0f0;
            padding: 15px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 12px;
            max-width: 400px;
            max-height: 200px;
            overflow-y: auto;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 999;
        }

        .log.active {
            display: block;
        }

        .log-entry {
            margin: 3px 0;
            padding: 3px 0;
            border-bottom: 1px solid #333;
        }

        .log-error {
            color: #f44;
        }

        .log-warning {
            color: #ff9800;
        }

        .log-info {
            color: #0ff;
        }

        .log-success {
            color: #4caf50;
        }

        /* ë°˜ì‘í˜• */
        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: auto;
                max-height: 200px;
            }

            .room-list {
                display: flex;
                gap: 10px;
                overflow-x: auto;
                overflow-y: hidden;
            }

            .room-item {
                flex-shrink: 0;
                min-width: 150px;
            }

            .message-content {
                max-width: 100%;
            }

            .modal-content {
                max-width: 90%;
            }
        }

        /* ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- ì¢Œì¸¡ íŒ¨ë„: ì±„íŒ…ë°© ëª©ë¡ -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h1>ğŸ’¬ SoBunSoBun</h1>
                <div class="connection-status">
                    <div class="status-indicator disconnected" id="statusIndicator"></div>
                    <span id="statusText">ì—°ê²° ëŒ€ê¸° ì¤‘</span>
                </div>
            </div>

            <div class="room-list" id="roomList">
                <div style="padding: 20px; text-align: center; color: #999;">
                    ì±„íŒ…ë°©ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                </div>
            </div>

            <div class="sidebar-footer">
                <button class="btn btn-primary" onclick="openSettingsModal()">âš™ï¸ ì„¤ì •</button>
                <button class="btn btn-danger" onclick="disconnect()">ğŸ“´ ì—°ê²° í•´ì œ</button>
            </div>
        </div>

        <!-- ìš°ì¸¡ íŒ¨ë„: ì±„íŒ… -->
        <div class="chat-panel">
            <div class="chat-header">
                <div>
                    <h2 id="currentRoomName">ì±„íŒ…ë°©ì„ ì„ íƒí•´ì£¼ì„¸ìš”</h2>
                    <div class="chat-header-info" id="currentRoomInfo"></div>
                </div>
            </div>

            <div class="messages-container" id="messagesContainer">
                <div class="no-messages">
                    <div class="no-messages-icon">ğŸ’­</div>
                    <div>ì±„íŒ…ë°©ì„ ì„ íƒí•˜ì—¬ ë©”ì‹œì§€ë¥¼ ì‹œì‘í•˜ì„¸ìš”</div>
                </div>
            </div>

            <div class="message-input-area">
                <div class="input-wrapper">
                    <textarea
                        class="message-input"
                        id="messageInput"
                        placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”... (Enter: ì „ì†¡, Shift+Enter: ì¤„ë°”ê¿ˆ)"
                        disabled
                    ></textarea>
                    <button class="btn-send" id="sendBtn" onclick="sendMessage()" disabled title="ë©”ì‹œì§€ ì „ì†¡">
                        ğŸ“¤
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ì„¤ì • ëª¨ë‹¬ -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">âš™ï¸ ì„¤ì •</div>
            <div class="modal-body">
                <div class="form-group">
                    <label>WebSocket ì£¼ì†Œ</label>
                    <input type="text" id="wsUrl" placeholder="ws://localhost:8080/ws/chat">
                    <small style="color: #999; margin-top: 5px; display: block;">
                        ì˜ˆ: ws://localhost:8080/ws/chat (ê°œë°œ) ë˜ëŠ” wss://domain.com/ws/chat (ìš´ì˜)
                    </small>
                </div>
                <div class="form-group">
                    <label>JWT í† í°</label>
                    <textarea id="token" placeholder="Bearer ì—†ì´ í† í°ë§Œ ì…ë ¥ (ì˜ˆ: eyJhbGciOiJIUzI1NiJ9...)"></textarea>
                    <small style="color: #999; margin-top: 5px; display: block;">
                        âœ… ì˜¬ë°”ë¥¸ ì˜ˆ: eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOi...
                        <br/>âŒ í‹€ë¦° ì˜ˆ: Bearer eyJhbGciOiJIUzI1NiJ9...
                    </small>
                </div>
                <div class="form-group">
                    <label>ì‚¬ìš©ì ì´ë¦„ (ì„ íƒì‚¬í•­)</label>
                    <input type="text" id="username" placeholder="ì‚¬ìš©ì ì´ë¦„">
                </div>
                <div style="background: #f0f0f0; padding: 12px; border-radius: 6px; margin-top: 15px;">
                    <div style="font-weight: 600; margin-bottom: 8px;">ğŸ” ì„œë²„ ìƒíƒœ í™•ì¸</div>
                    <button class="btn btn-primary" style="width: 100%; font-size: 12px;" onclick="testServerConnection()">
                        í…ŒìŠ¤íŠ¸
                    </button>
                    <div id="serverStatus" style="margin-top: 8px; font-size: 12px; color: #666;"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-cancel" onclick="closeSettingsModal()">ì·¨ì†Œ</button>
                <button class="btn btn-primary" onclick="saveSettings()">ì €ì¥ ë° ì—°ê²°</button>
            </div>
        </div>
    </div>

    <!-- ë””ë²„ê·¸ ë¡œê·¸ -->
    <div class="log" id="debugLog"></div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let stompClient = null;
        let currentRoomId = null;
        let connectedRooms = new Set();
        let isConnected = false;
        let userId = null;
        let userNickname = null;

        // ì´ˆê¸°í™”
        window.addEventListener('load', () => {
            initializeUrls();
            log('ğŸ¯ ì±„íŒ… ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘', 'info');
            log('ğŸ’¡ íŒ: F12 í‚¤ë¥¼ ëˆŒëŸ¬ ë””ë²„ê·¸ ë¡œê·¸ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤', 'info');

            // DOM ìš”ì†Œ í™•ì¸
            const roomList = document.getElementById('roomList');
            const messagesContainer = document.getElementById('messagesContainer');
            const messageInput = document.getElementById('messageInput');

            log(`ğŸ” DOM ìš”ì†Œ í™•ì¸:`, 'info');
            log(`  - roomList: ${roomList ? 'âœ… ì¡´ì¬' : 'âŒ ì—†ìŒ'}`, 'info');
            log(`  - messagesContainer: ${messagesContainer ? 'âœ… ì¡´ì¬' : 'âŒ ì—†ìŒ'}`, 'info');
            log(`  - messageInput: ${messageInput ? 'âœ… ì¡´ì¬' : 'âŒ ì—†ìŒ'}`, 'info');

            loadSettings();
        });

        // URL ì´ˆê¸°í™”
        function initializeUrls() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const hostname = window.location.hostname;

            // IDE í™˜ê²½ ê°ì§€ (í¬íŠ¸ > 60000 = ì¼ë°˜ì ìœ¼ë¡œ IDE í¬íŠ¸)
            const port = parseInt(window.location.port) || 0;
            const isIDEEnvironment = port > 60000;

            let wsUrl;
            let apiBaseUrl;

            log(`ğŸŒ í˜¸ìŠ¤íŠ¸ ì •ë³´:`, 'info');
            log(`  í˜„ì¬ í˜¸ìŠ¤íŠ¸: ${hostname}`, 'info');
            log(`  í˜„ì¬ í¬íŠ¸: ${port}`, 'info');
            log(`  í˜„ì¬ URL: ${window.location.href}`, 'info');

            if (isIDEEnvironment) {
                // IDE í™˜ê²½: ê¸°ë³¸ í¬íŠ¸(8080/8081) ì¤‘ ì„ íƒ
                // ë¨¼ì € 8081 ì‹œë„ (ê°€ì¥ ì¼ë°˜ì )
                wsUrl = `ws://localhost:8081/ws/chat`;
                apiBaseUrl = `http://localhost:8081`;
                log('ğŸ” IDE í™˜ê²½ ê°ì§€ë¨ - localhost:8081 ìœ¼ë¡œ ì„¤ì •', 'warning');
            } else {
                // í”„ë¡œë•ì…˜ í™˜ê²½: í˜„ì¬ í˜¸ìŠ¤íŠ¸ë¡œ ë™ì  ì—°ê²°
                // localhost:8081, 158.180.80.135:8081 ëª¨ë‘ ì§€ì›
                wsUrl = `${protocol}//${hostname}${port ? `:${port}` : ''}/ws/chat`;
                apiBaseUrl = port ? `${window.location.protocol}//${hostname}:${port}` : `${window.location.protocol}//${hostname}`;
                log(`ğŸ“ í”„ë¡œë•ì…˜ í™˜ê²½ - í˜„ì¬ í˜¸ìŠ¤íŠ¸ë¡œ ì„¤ì •`, 'info');
                log(`  WebSocket: ${wsUrl}`, 'info');
                log(`  API Base: ${apiBaseUrl}`, 'info');
            }

            document.getElementById('wsUrl').value = wsUrl;
            localStorage.setItem('apiBaseUrl', apiBaseUrl);
            log(`âœ… ì„œë²„ ì„¤ì • ì™„ë£Œ: ${wsUrl}`, 'success');
        }

        // ì„¤ì • ì €ì¥ ë° ë¡œë“œ
        function saveSettings() {
            const wsUrl = document.getElementById('wsUrl').value;
            const token = document.getElementById('token').value;
            const username = document.getElementById('username').value;

            if (!wsUrl || !token) {
                alert('WebSocket ì£¼ì†Œì™€ í† í°ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.');
                return;
            }

            if (token.startsWith('Bearer ')) {
                alert('âŒ í† í° í˜•ì‹ ì˜¤ë¥˜: Bearer ì ‘ë‘ì‚¬ë¥¼ ì œê±°í•´ì£¼ì„¸ìš”.\nì˜¬ë°”ë¥¸ í˜•ì‹: eyJhbGciOiJIUzI1NiJ9...');
                return;
            }

            localStorage.setItem('wsUrl', wsUrl);
            localStorage.setItem('token', token);
            localStorage.setItem('username', username);

            closeSettingsModal();
            connect(wsUrl, token, username);
        }

        function loadSettings() {
            const wsUrl = localStorage.getItem('wsUrl');
            const token = localStorage.getItem('token');
            const username = localStorage.getItem('username');

            if (wsUrl) document.getElementById('wsUrl').value = wsUrl;
            if (token) document.getElementById('token').value = token;
            if (username) document.getElementById('username').value = username;

            if (wsUrl && token) {
                connect(wsUrl, token, username || 'Anonymous');
            } else {
                openSettingsModal();
            }
        }

        function testServerConnection() {
            const wsUrl = document.getElementById('wsUrl').value;
            const token = document.getElementById('token').value;
            const statusDiv = document.getElementById('serverStatus');

            if (!wsUrl || !token) {
                statusDiv.innerHTML = '<span style="color: #f44;">âŒ WebSocket ì£¼ì†Œì™€ í† í°ì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”</span>';
                return;
            }

            statusDiv.innerHTML = '<span style="color: #0ff;">ğŸ”„ í…ŒìŠ¤íŠ¸ ì¤‘...</span>';

            // WebSocket URLì—ì„œ HTTP URLë¡œ ë³€í™˜
            const httpUrl = wsUrl.replace(/^wss?:/, 'http:').replace(/\/ws\/chat$/, '');
            const healthUrl = `${httpUrl}/health`;

            log(`ğŸ” ì„œë²„ ìƒíƒœ í…ŒìŠ¤íŠ¸: ${healthUrl}`, 'info');

            fetch(healthUrl, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(res => {
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                return res.json();
            })
            .then(data => {
                statusDiv.innerHTML = `
                    <span style="color: #4caf50;">âœ… ì„œë²„ ì •ìƒ</span>
                    <div style="margin-top: 5px; font-size: 11px; color: #666;">
                        ìƒíƒœ: ${data.status || 'UP'}<br/>
                        ${data.timestamp ? 'ì‹œê°„: ' + new Date(data.timestamp).toLocaleString() : ''}
                    </div>
                `;
                log('âœ… ì„œë²„ ìƒíƒœ í™•ì¸ ì™„ë£Œ', 'success');
            })
            .catch(err => {
                statusDiv.innerHTML = `
                    <span style="color: #f44;">âŒ ì„œë²„ ì—°ê²° ì‹¤íŒ¨</span>
                    <div style="margin-top: 5px; font-size: 11px; color: #f44;">
                        ì˜¤ë¥˜: ${err.message}<br/>
                        URL: ${healthUrl}<br/>
                        <br/>
                        ğŸ’¡ í•´ê²°ë°©ë²•:<br/>
                        1. ë°±ì—”ë“œ ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸ (í¬íŠ¸ 8080 ë˜ëŠ” 8081)<br/>
                        2. WebSocket URL í™•ì¸<br/>
                        3. ë°©í™”ë²½/í¬íŠ¸ ì„¤ì • í™•ì¸<br/>
                        <br/>
                        ğŸ’¡ í¬íŠ¸ ë³€ê²½:<br/>
                        - í¬íŠ¸ 8080 ì‚¬ìš©: ws://localhost:8080/ws/chat<br/>
                        - í¬íŠ¸ 8081 ì‚¬ìš©: ws://localhost:8081/ws/chat
                    </div>
                `;
                log(`âŒ ì„œë²„ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨: ${err.message}`, 'error');
            });
        }

        // ì—°ê²°
        let reconnectAttempts = 0;
        const MAX_RECONNECT_ATTEMPTS = 5;
        let reconnectTimeout = null;

        function connect(wsUrl, token, username) {
            if (!token.startsWith('Bearer ')) {
                token = 'Bearer ' + token;
            }

            userNickname = username;
            log(`ğŸ”Œ ì—°ê²° ì‹œë„: ${wsUrl}`, 'info');
            log(`ğŸ“ ì‚¬ìš©ì: ${username}`, 'info');

            const client = new StompJs.Client({
                brokerURL: wsUrl,
                connectHeaders: {
                    'Authorization': token
                },
                reconnectDelay: 5000,
                heartbeatIncoming: 4000,
                heartbeatOutgoing: 4000,
                // ...existing code...
                onConnect: () => {
                    isConnected = true;
                    reconnectAttempts = 0;
                    updateConnectionStatus(true);
                    log('âœ… STOMP ì—°ê²° ì„±ê³µ!', 'success');
                    log('ğŸ“¡ ì±„íŒ… ì¤€ë¹„ ì™„ë£Œ', 'info');
                    loadChatRooms();

                    // í† í°ì—ì„œ ì‚¬ìš©ì ì •ë³´ ì¶”ì¶œ (ì„ íƒì‚¬í•­)
                    try {
                        const tokenParts = token.replace('Bearer ', '').split('.');
                        const payload = JSON.parse(atob(tokenParts[1]));
                        userId = payload.userId || payload.sub || payload.id;
                        log(`ğŸ‘¤ ì‚¬ìš©ì ID: ${userId}`, 'success');
                    } catch (e) {
                        log('âš ï¸ í† í° íŒŒì‹± ì‹¤íŒ¨ (ë¬´ì‹œë¨)', 'warning');
                    }
                },
                onStompError: (frame) => {
                    log(`âŒ STOMP ì˜¤ë¥˜: ${frame.body || frame.message || 'Unknown error'}`, 'error');
                    attemptReconnect(wsUrl, token, username);
                },
                onWebSocketError: (event) => {
                    const errorMsg = event?.reason || 'Connection failed';
                    log(`âŒ WebSocket ì˜¤ë¥˜: ${errorMsg}`, 'error');
                    log('ğŸ’¡ í™•ì¸ì‚¬í•­:', 'warning');
                    log('  1. ë°±ì—”ë“œ ì„œë²„ ì‹¤í–‰ í™•ì¸ (http://localhost:8080/health)', 'warning');
                    log('  2. WebSocket URL í™•ì¸: ' + document.getElementById('wsUrl').value, 'warning');
                    log('  3. JWT í† í° ìœ íš¨ì„± í™•ì¸', 'warning');
                    attemptReconnect(wsUrl, token, username);
                },
                onDisconnect: () => {
                    isConnected = false;
                    updateConnectionStatus(false);
                    log('ğŸ“´ ì—°ê²° í•´ì œë¨', 'warning');
                }
            });

            stompClient = client;
            client.activate();
        }

        function attemptReconnect(wsUrl, token, username) {
            if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                reconnectAttempts++;
                const delay = 5000 * reconnectAttempts; // 5ì´ˆ, 10ì´ˆ, 15ì´ˆ...
                log(`ğŸ”„ ${reconnectAttempts}/${MAX_RECONNECT_ATTEMPTS} ì¬ì—°ê²° ì‹œë„ (${delay/1000}ì´ˆ í›„)...`, 'warning');

                if (reconnectTimeout) clearTimeout(reconnectTimeout);
                reconnectTimeout = setTimeout(() => {
                    connect(wsUrl, token, username);
                }, delay);
            } else {
                log(`âŒ ìµœëŒ€ ì¬ì—°ê²° ì‹œë„ íšŸìˆ˜(${MAX_RECONNECT_ATTEMPTS}) ì´ˆê³¼`, 'error');
                log('âš ï¸ ë‹¤ìŒì„ í™•ì¸í•´ì£¼ì„¸ìš”:', 'error');
                log('  1. ë°±ì—”ë“œ ì„œë²„ ì‹¤í–‰ (í¬íŠ¸ 8080 ë˜ëŠ” 8081)', 'error');
                log('  2. WebSocket URL ì˜¬ë°”ë¦„ (ì˜ˆ: ws://localhost:8081/ws/chat)', 'error');
                log('  3. JWT í† í° ìœ íš¨ì„± (Bearer ì ‘ë‘ì‚¬ ì œì™¸)', 'error');
                log('  4. ì„œë²„ ë¡œê·¸ì—ì„œ "400 BAD_REQUEST" ì˜¤ë¥˜ í™•ì¸', 'error');
                log('  5. CORS ì„¤ì • ë° SecurityConfig í™•ì¸', 'error');
            }
        }

        // ì±„íŒ…ë°© ëª©ë¡ ë¡œë“œ
        function loadChatRooms() {
            const wsUrl = document.getElementById('wsUrl').value;
            const token = document.getElementById('token').value;

            const baseUrl = wsUrl.split('/ws')[0].replace(/^ws/, 'http');
            const apiUrl = `${baseUrl}/api/v1/chat/rooms`;

            log(`ğŸ“¡ ì±„íŒ…ë°© ëª©ë¡ ë¡œë“œ ì¤‘: ${apiUrl}`, 'info');

            fetch(apiUrl, {
                method: 'GET',
                headers: {
                    'Authorization': token.startsWith('Bearer ') ? token : 'Bearer ' + token,
                    'Content-Type': 'application/json'
                }
            })
            .then(res => {
                log(`ğŸ“Š ì‘ë‹µ ìƒíƒœ: ${res.status}`, 'info');
                if (!res.ok) {
                    throw new Error(`HTTP ${res.status}`);
                }
                return res.json();
            })
            .then(data => {
                log(`ğŸ“‹ API ì‘ë‹µ ìˆ˜ì‹  ì™„ë£Œ`, 'info');

                // API ì‘ë‹µ êµ¬ì¡°: { data: { content: [...] } }
                let rooms = [];

                if (data.data && data.data.content && Array.isArray(data.data.content)) {
                    rooms = data.data.content;
                    log(`âœ… ì‘ë‹µì—ì„œ ${rooms.length}ê°œ ì±„íŒ…ë°© ì¶”ì¶œë¨`, 'success');
                } else {
                    log(`âš ï¸ ì˜ˆìƒí•˜ì§€ ëª»í•œ ì‘ë‹µ í˜•ì‹ - data êµ¬ì¡°: ${Object.keys(data).join(', ')}`, 'warning');
                    if (data.data) {
                        log(`âš ï¸ data í‚¤ ì¡´ì¬: ${Object.keys(data.data).join(', ')}`, 'warning');
                    }
                }

                if (rooms && rooms.length > 0) {
                    log(`ğŸ¯ ì±„íŒ…ë°© ëª©ë¡ ë Œë”ë§ ì‹œì‘ (${rooms.length}ê°œ)`, 'info');
                    renderRoomList(rooms);
                    log(`âœ… ì±„íŒ…ë°© ëª©ë¡ ë Œë”ë§ ì™„ë£Œ`, 'success');
                } else {
                    log(`ğŸ’­ ì±„íŒ…ë°©ì´ ì—†ê±°ë‚˜ ì¶”ì¶œ ì‹¤íŒ¨`, 'warning');
                    renderRoomList([]);
                }
            })
            .catch(err => {
                log(`âŒ ì±„íŒ…ë°© ë¡œë“œ ì‹¤íŒ¨: ${err.message}`, 'error');
                log(`ğŸ“ URL: ${apiUrl}`, 'error');
                renderRoomList([]);
            });
        }

        // ì±„íŒ…ë°© ëª©ë¡ ë Œë”ë§
        function renderRoomList(rooms) {
            const roomList = document.getElementById('roomList');

            log(`ğŸ¨ renderRoomList() í˜¸ì¶œ - ì±„íŒ…ë°© ìˆ˜: ${rooms ? rooms.length : 0}`, 'info');

            if (!rooms || rooms.length === 0) {
                const emptyHtml = '<div style="padding: 20px; text-align: center; color: #999;">ğŸ“­ ì±„íŒ…ë°©ì´ ì—†ìŠµë‹ˆë‹¤</div>';
                roomList.innerHTML = emptyHtml;
                log(`âœ… ë¹ˆ ìƒíƒœ ë Œë”ë§ ì™„ë£Œ`, 'info');
                return;
            }

            try {
                let htmlContent = '';

                rooms.forEach((room, idx) => {
                    const roomId = room.id || room.roomId;
                    const roomName = (room.name || room.roomName || 'Unnamed').replace(/'/g, "\\'");
                    const roomDesc = room.description || '';

                    if (!roomId) {
                        log(`âš ï¸ ì±„íŒ…ë°© ${idx}ë²ˆ: IDê°€ ì—†ìŠµë‹ˆë‹¤ - ${JSON.stringify(room)}`, 'warning');
                        return;
                    }

                    const html = `
                        <div class="room-item" data-room-id="${roomId}" onclick="selectRoom(${roomId}, '${roomName}')">
                            <div class="room-item-name">${escapeHtml(room.name || room.roomName || 'Unnamed')}</div>
                            <div class="room-item-desc">${escapeHtml(roomDesc)}</div>
                        </div>
                    `;

                    htmlContent += html;
                    log(`  âœ… [${idx+1}] ${room.name || room.roomName} (ID: ${roomId})`, 'info');
                });

                if (htmlContent) {
                    roomList.innerHTML = htmlContent;
                    log(`âœ… ${rooms.length}ê°œ ì±„íŒ…ë°© HTML ë Œë”ë§ ì™„ë£Œ`, 'success');
                } else {
                    roomList.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">ğŸ“­ í‘œì‹œí•  ì±„íŒ…ë°©ì´ ì—†ìŠµë‹ˆë‹¤</div>';
                    log(`âš ï¸ ìœ íš¨í•œ ì±„íŒ…ë°©ì´ ì—†ì–´ ë¹ˆ ìƒíƒœë¡œ ë Œë”ë§`, 'warning');
                }
            } catch (err) {
                log(`âŒ ë Œë”ë§ ì¤‘ ì˜¤ë¥˜: ${err.message}`, 'error');
                roomList.innerHTML = '<div style="padding: 20px; text-align: center; color: red;">âŒ ë Œë”ë§ ì˜¤ë¥˜</div>';
            }
        }

        // ì±„íŒ…ë°© ì„ íƒ
        function selectRoom(roomId, roomName) {
            log(`ğŸ¯ selectRoom() í˜¸ì¶œ - roomId: ${roomId}, roomName: ${roomName}`, 'info');

            if (currentRoomId === roomId) {
                log(`â„¹ï¸ ì´ë¯¸ ì„ íƒëœ ì±„íŒ…ë°©: ${roomId}`, 'info');
                return;
            }

            currentRoomId = roomId;
            log(`âœ… currentRoomId ì„¤ì •: ${roomId}`, 'info');

            // ì´ì „ ì„ íƒ ì œê±°
            document.querySelectorAll('.room-item').forEach(el => {
                el.classList.remove('active');
            });

            // í˜„ì¬ ì„ íƒ í•­ëª© ì°¾ê¸° ë° í™œì„±í™”
            const selectedRoom = document.querySelector(`.room-item[data-room-id="${roomId}"]`);
            if (selectedRoom) {
                selectedRoom.classList.add('active');
                log(`âœ… UI í™œì„±í™” ìƒíƒœ ë³€ê²½ ì™„ë£Œ`, 'info');
            } else {
                log(`âš ï¸ DOMì—ì„œ room-item[data-room-id="${roomId}"] ìš”ì†Œ ì°¾ì„ ìˆ˜ ì—†ìŒ`, 'warning');
            }

            // UI ì—…ë°ì´íŠ¸
            const titleEl = document.getElementById('currentRoomName');
            const infoEl = document.getElementById('currentRoomInfo');
            const inputEl = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendBtn');

            if (titleEl) titleEl.textContent = roomName;
            if (infoEl) infoEl.textContent = `ì±„íŒ…ë°© #${roomId}`;
            if (inputEl) inputEl.disabled = false;
            if (sendBtn) sendBtn.disabled = false;

            log(`âœ… UI í—¤ë” ì—…ë°ì´íŠ¸ ì™„ë£Œ`, 'info');

            // ë©”ì‹œì§€ ì˜ì—­ ì´ˆê¸°í™”
            clearMessages();
            log(`âœ… ë©”ì‹œì§€ ì˜ì—­ ì´ˆê¸°í™” ì™„ë£Œ`, 'info');

            // ê³¼ê±° ë©”ì‹œì§€ ë¡œë“œ
            log(`ğŸ“¥ ê³¼ê±° ë©”ì‹œì§€ ë¡œë“œ ì‹œì‘...`, 'info');
            loadMessages();

            // ì±„íŒ…ë°© êµ¬ë…
            log(`ğŸ“¡ ì±„íŒ…ë°© êµ¬ë… ì‹œì‘...`, 'info');
            subscribeToRoom(roomId);

            log(`ğŸ¯ ì±„íŒ…ë°© ì„ íƒ ì™„ë£Œ: ${roomName} (#${roomId})`, 'success');
        }

        // ë©”ì‹œì§€ ë¡œë“œ
        function loadMessages() {
            if (!currentRoomId) {
                log(`âŒ ì±„íŒ…ë°©ì´ ì„ íƒë˜ì§€ ì•ŠìŒ`, 'error');
                return;
            }

            const wsUrl = document.getElementById('wsUrl').value;
            const token = document.getElementById('token').value;

            const baseUrl = wsUrl.split('/ws')[0].replace(/^ws/, 'http');
            const apiUrl = `${baseUrl}/api/v1/chat/rooms/${currentRoomId}/messages?page=0&size=50`;

            log(`ğŸ“¥ ë©”ì‹œì§€ ë¡œë“œ: ${apiUrl}`, 'info');

            fetch(apiUrl, {
                method: 'GET',
                headers: {
                    'Authorization': token.startsWith('Bearer ') ? token : 'Bearer ' + token,
                    'Content-Type': 'application/json'
                }
            })
            .then(res => {
                log(`ğŸ“Š API ì‘ë‹µ ìƒíƒœ: ${res.status}`, 'info');
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                return res.json();
            })
            .then(data => {
                let messages = [];

                // ë‹¤ì–‘í•œ ì‘ë‹µ í˜•ì‹ ì§€ì›
                if (Array.isArray(data)) {
                    messages = data;
                    log(`âœ… ì‘ë‹µ í˜•ì‹: ì§ì ‘ ë°°ì—´`, 'info');
                } else if (data.data) {
                    if (Array.isArray(data.data)) {
                        messages = data.data;
                        log(`âœ… ì‘ë‹µ í˜•ì‹: data (ë°°ì—´)`, 'info');
                    } else if (data.data.content) {
                        messages = data.data.content;
                        log(`âœ… ì‘ë‹µ í˜•ì‹: data.content (ë°°ì—´)`, 'info');
                    }
                } else if (data.content && Array.isArray(data.content)) {
                    messages = data.content;
                    log(`âœ… ì‘ë‹µ í˜•ì‹: content (ë°°ì—´)`, 'info');
                }

                // ì˜¤ë˜ëœ ìˆœì„œëŒ€ë¡œ ì •ë ¬
                messages.reverse();
                log(`âœ… ${messages.length}ê°œ ë©”ì‹œì§€ ë¡œë“œë¨`, 'success');

                messages.forEach((msg, idx) => {
                    log(`  [${idx+1}] ${msg.senderNickname || msg.senderName || 'ì•Œ ìˆ˜ ì—†ìŒ'}: ${msg.content.substring(0, 30)}...`, 'info');
                    renderMessage(msg, false);
                });

                // ìŠ¤í¬ë¡¤ ë§¨ ì•„ë˜ë¡œ
                setTimeout(() => {
                    const container = document.getElementById('messagesContainer');
                    if (container) {
                        container.scrollTop = container.scrollHeight;
                    }
                }, 100);
            })
            .catch(err => {
                log(`âŒ ë©”ì‹œì§€ ë¡œë“œ ì‹¤íŒ¨: ${err.message}`, 'error');
                log(`ğŸ“ API URL: ${apiUrl}`, 'error');
            });
        }

        // ì±„íŒ…ë°© êµ¬ë…
        function subscribeToRoom(roomId) {
            if (!stompClient) {
                log(`âŒ STOMP í´ë¼ì´ì–¸íŠ¸ ë¯¸ì´ˆê¸°í™”`, 'error');
                return;
            }

            if (!isConnected) {
                log(`âŒ WebSocket ë¯¸ì—°ê²°`, 'error');
                return;
            }

            const destination = `/topic/rooms/${roomId}`;

            if (connectedRooms.has(roomId)) {
                log(`â„¹ï¸ ì´ë¯¸ êµ¬ë… ì¤‘ì¸ ì±„íŒ…ë°©: ${roomId}`, 'info');
                return;
            }

            try {
                log(`ğŸ“¡ ì±„íŒ…ë°© êµ¬ë… ì‹œì‘: ${destination}`, 'info');

                stompClient.subscribe(destination, (message) => {
                    try {
                        log(`ğŸ“¨ ë©”ì‹œì§€ í”„ë ˆì„ ìˆ˜ì‹ : ${message.body.substring(0, 100)}...`, 'info');

                        const msg = JSON.parse(message.body);
                        log(`âœ… ë©”ì‹œì§€ íŒŒì‹± ì„±ê³µ: ${msg.senderNickname || msg.sender?.nickname || 'ì•Œ ìˆ˜ ì—†ìŒ'}`, 'success');

                        renderMessage(msg, true);
                    } catch (e) {
                        log(`âŒ ë©”ì‹œì§€ íŒŒì‹± ì˜¤ë¥˜: ${e.message}`, 'error');
                    }
                });

                connectedRooms.add(roomId);
                log(`âœ… ì±„íŒ…ë°© ${roomId} êµ¬ë… ì™„ë£Œ`, 'success');
            } catch (err) {
                log(`âŒ êµ¬ë… ì˜¤ë¥˜: ${err.message}`, 'error');
            }
        }

        // ë©”ì‹œì§€ ë Œë”ë§
        function renderMessage(msg, scroll = true) {
            const container = document.getElementById('messagesContainer');

            if (!container) {
                log(`âŒ messagesContainer ìš”ì†Œ ì—†ìŒ`, 'error');
                return;
            }

            // ë¹ˆ ìƒíƒœ ì œê±°
            const emptyMsg = container.querySelector('.no-messages');
            if (emptyMsg) {
                emptyMsg.remove();
            }

            const isOwn = msg.senderId === userId || msg.sender?.id === userId;
            const senderName = msg.senderNickname || msg.sender?.nickname || msg.senderName || 'Unknown';
            const content = msg.content || '(ë©”ì‹œì§€ ì—†ìŒ)';
            const timestamp = formatTime(msg.createdAt || msg.timestamp || new Date());

            const messageEl = document.createElement('div');
            messageEl.className = `message-group ${isOwn ? 'own' : ''}`;
            messageEl.innerHTML = `
                ${!isOwn ? `<div class="message-avatar">${senderName.charAt(0).toUpperCase()}</div>` : ''}
                <div class="message-content">
                    ${!isOwn ? `<div class="message-sender">${senderName}</div>` : ''}
                    <div class="message-text">${escapeHtml(content)}</div>
                    <div class="message-time">${timestamp}</div>
                </div>
                ${isOwn ? `<div class="message-avatar">${senderName.charAt(0).toUpperCase()}</div>` : ''}
            `;

            container.appendChild(messageEl);

            if (scroll) {
                setTimeout(() => {
                    container.scrollTop = container.scrollHeight;
                }, 10);
            }
        }

        // ë©”ì‹œì§€ ì „ì†¡
        function sendMessage() {
            if (!stompClient) {
                log(`âŒ STOMP í´ë¼ì´ì–¸íŠ¸ ë¯¸ì´ˆê¸°í™”`, 'error');
                return;
            }

            if (!isConnected) {
                log(`âŒ WebSocket ë¯¸ì—°ê²°`, 'error');
                return;
            }

            if (!currentRoomId) {
                log(`âŒ ì±„íŒ…ë°© ë¯¸ì„ íƒ`, 'error');
                return;
            }

            const input = document.getElementById('messageInput');

            if (!input) {
                log(`âŒ messageInput ìš”ì†Œ ì—†ìŒ`, 'error');
                return;
            }

            const content = input.value.trim();

            if (!content) {
                log(`â„¹ï¸ ë¹ˆ ë©”ì‹œì§€ëŠ” ì „ì†¡ë˜ì§€ ì•ŠìŒ`, 'info');
                return;
            }

            try {
                const message = {
                    roomId: currentRoomId,
                    content: content,
                    type: 'TEXT'
                };

                log(`ğŸ’¬ ë©”ì‹œì§€ ì „ì†¡ ì¤‘: "${content}"`, 'info');
                log(`ğŸ“ ì±„íŒ…ë°©: ${currentRoomId}`, 'info');

                stompClient.publish({
                    destination: '/app/chat/send',
                    body: JSON.stringify(message)
                });

                log(`âœ… ë©”ì‹œì§€ ì „ì†¡ ì™„ë£Œ`, 'success');
                input.value = '';

                // ì»¤ì„œë¥¼ ì…ë ¥ í•„ë“œì— ìœ ì§€
                input.focus();
            } catch (err) {
                log(`âŒ ë©”ì‹œì§€ ì „ì†¡ ì˜¤ë¥˜: ${err.message}`, 'error');
            }
        }

        // ë©”ì‹œì§€ ì˜ì—­ ì´ˆê¸°í™”
        function clearMessages() {
            const container = document.getElementById('messagesContainer');
            if (container) {
                container.innerHTML = `
                    <div class="no-messages">
                        <div class="no-messages-icon">ğŸ’­</div>
                        <div>ë©”ì‹œì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                    </div>
                `;
            }
        }

        // Enter í‚¤ë¡œ ì „ì†¡
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('messageInput').addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
        });

        // ëª¨ë‹¬ ì œì–´
        function openSettingsModal() {
            document.getElementById('settingsModal').classList.add('active');
        }

        function closeSettingsModal() {
            document.getElementById('settingsModal').classList.remove('active');
        }

        // ì—°ê²° í•´ì œ
        function disconnect() {
            if (stompClient) {
                stompClient.deactivate();
                log('ì—°ê²° í•´ì œë¨', 'info');
            }
        }

        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
        function updateConnectionStatus(connected) {
            const indicator = document.getElementById('statusIndicator');
            const text = document.getElementById('statusText');

            if (connected) {
                indicator.className = 'status-indicator connected';
                text.textContent = 'ì—°ê²°ë¨';
            } else {
                indicator.className = 'status-indicator disconnected';
                text.textContent = 'ì—°ê²° ëŠê¹€';
            }
        }

        function formatTime(date) {
            if (typeof date === 'string') {
                date = new Date(date);
            }
            const now = new Date();
            const diff = now - date;

            if (diff < 60000) return 'ë°©ê¸ˆ';
            if (diff < 3600000) return `${Math.floor(diff / 60000)}ë¶„ ì „`;
            if (diff < 86400000) return `${Math.floor(diff / 3600000)}ì‹œê°„ ì „`;

            return date.toLocaleDateString('ko-KR', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function clearMessages() {
            document.getElementById('messagesContainer').innerHTML = `
                <div class="no-messages">
                    <div class="no-messages-icon">ğŸ’­</div>
                    <div>ë©”ì‹œì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                </div>
            `;
        }

        function log(message, type = 'info') {
            const logEl = document.getElementById('debugLog');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            const time = new Date().toLocaleTimeString();
            entry.textContent = `[${time}] ${message}`;
            logEl.appendChild(entry);

            // ìµœëŒ€ 50ê°œê¹Œì§€ë§Œ ìœ ì§€
            while (logEl.children.length > 50) {
                logEl.removeChild(logEl.firstChild);
            }

            logEl.scrollTop = logEl.scrollHeight;
        }

        // ë””ë²„ê·¸ ë¡œê·¸ í‘œì‹œ/ìˆ¨ê¸°ê¸° (F12)
        document.addEventListener('keydown', (e) => {
            if (e.code === 'F12') {
                document.getElementById('debugLog').classList.toggle('active');
            }
        });
    </script>
</body>
</html>

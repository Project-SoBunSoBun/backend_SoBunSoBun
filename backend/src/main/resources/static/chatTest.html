<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì†Œë¶„ì†Œë¶„ ì±„íŒ… í…ŒìŠ¤íŠ¸</title>
    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7.0.0/bundles/stomp.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 500px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h2 { margin-bottom: 20px; color: #333; }
        .control-panel {
            display: grid;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 5px;
        }
        .input-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        label { font-weight: bold; min-width: 100px; }
        input[type="number"], input[type="text"] {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            padding: 10px 15px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s;
        }
        button:hover { background: #45a049; }
        button.disconnect { background: #f44336; }
        button.disconnect:hover { background: #da190b; }
        #status {
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 4px;
            font-weight: bold;
            text-align: center;
        }
        #status.connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        #status.disconnected {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        #chat-box {
            width: 100%;
            height: 350px;
            border: 2px solid #ddd;
            overflow-y: auto;
            margin-bottom: 15px;
            padding: 12px;
            background: #fafafa;
            border-radius: 5px;
            font-size: 13px;
            line-height: 1.6;
        }
        .msg {
            margin-bottom: 8px;
            padding: 6px;
            background: white;
            border-left: 3px solid #4CAF50;
            border-radius: 3px;
        }
        .msg-input-group {
            display: flex;
            gap: 10px;
        }
        #message {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        #message:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 5px rgba(76, 175, 80, 0.3);
        }
    </style>
</head>
<body>
<div class="container">
    <h2>ğŸ¯ ì†Œë¶„ì†Œë¶„ WebSocket ì±„íŒ… í…ŒìŠ¤íŠ¸</h2>

    <!-- ë¡œê·¸ì¸ ì˜ì—­ -->
    <div id="loginSection" style="margin-bottom: 20px; padding: 15px; background: #e3f2fd; border-radius: 5px;">
        <div style="display: flex; gap: 10px; align-items: center;">
            <label style="font-weight: bold; min-width: 80px;">JWT í† í°:</label>
            <input type="text" id="jwtTokenLogin" placeholder="JWT í† í° ì…ë ¥..." style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            <button onclick="loginWithToken()" style="padding: 8px 15px; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer;">ë¡œê·¸ì¸</button>
        </div>
    </div>

    <!-- ì‚¬ìš©ì ì •ë³´ í‘œì‹œ ì˜ì—­ -->
    <div id="userInfo" style="display: none; margin-bottom: 20px; padding: 15px; background: #c8e6c9; border-radius: 5px;">
        <div style="font-weight: bold; color: #1b5e20;">
            ğŸ‘‹ <span id="userNickname"></span>ë‹˜ ì•ˆë…•í•˜ì„¸ìš”!
            <button onclick="logout()" style="float: right; padding: 5px 10px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer;">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </div>

    <div id="status" class="disconnected">âŒ ì—°ê²° ì•ˆ ë¨</div>

    <div class="control-panel">
        <div class="input-row">
            <label>ì±„íŒ…ë°© ID:</label>
            <input type="number" id="roomId" value="1" min="1">
        </div>
        <div class="input-row">
            <label>ë‚´ ì‚¬ìš©ì ID:</label>
            <input type="number" id="senderId" value="100" min="1">
            <span style="font-size: 12px; color: #666; white-space: nowrap;">ğŸ‘¤ (DBì˜ User ID)</span>
        </div>
        <div class="input-row">
            <button onclick="connect()">âœ… ì ‘ì† ë° ë°© ì…ì¥</button>
            <button class="disconnect" onclick="disconnect()">âŒ ì—°ê²° ëŠê¸°</button>
        </div>
    </div>

    <div id="chat-box"></div>

    <div class="msg-input-group">
        <input type="text" id="message" placeholder="ë©”ì‹œì§€ ì…ë ¥ í›„ Enter ë˜ëŠ” ì „ì†¡ í´ë¦­..." onkeypress="if(event.keyCode==13) sendMessage()">
        <button onclick="sendMessage()">ì „ì†¡</button>
    </div>

    <!-- ë¡œê·¸ ì˜ì—­ -->
    <div style="margin-top: 20px; border-top: 2px solid #ccc; padding-top: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h3 style="margin: 0;">ğŸ“‹ ì‹œìŠ¤í…œ ë¡œê·¸</h3>
            <button onclick="clearLogs()" style="padding: 5px 10px; background: #ff9800; color: white; border: none; border-radius: 4px; cursor: pointer;">ë¡œê·¸ ì§€ìš°ê¸°</button>
        </div>
        <div id="log-box" style="width: 100%; height: 200px; border: 2px solid #ddd; overflow-y: auto; padding: 10px; background: #000; color: #0f0; font-family: 'Courier New', monospace; font-size: 11px; line-height: 1.4; border-radius: 5px;"></div>
    </div>
</div>

<script>
    let stompClient = null;
    let currentJwtToken = null;
    let currentUser = null;
    let currentRoomId = null;  // âœ… ì „ì—­ ë³€ìˆ˜ ì¶”ê°€
    let currentSenderId = null;  // âœ… ì „ì—­ ë³€ìˆ˜ ì¶”ê°€

    /**
     * JWT í† í°ìœ¼ë¡œ ë¡œê·¸ì¸í•˜ê³  ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ
     */
    function loginWithToken() {
        const jwtToken = document.getElementById('jwtTokenLogin').value.trim();

        if (!jwtToken) {
            alert('JWT í† í°ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
            return;
        }

        appendLog('ğŸ” ë¡œê·¸ì¸ ì‹œë„: ' + jwtToken.substring(0, 30) + '...');

        // /api/me ì—”ë“œí¬ì¸íŠ¸ í˜¸ì¶œí•˜ì—¬ ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ
        fetch('http://localhost:8081/api/me', {
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + jwtToken,
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('ë¡œê·¸ì¸ ì‹¤íŒ¨: ' + response.status);
            }
            return response.json();
        })
        .then(data => {
            // ë¡œê·¸ì¸ ì„±ê³µ
            currentJwtToken = jwtToken;
            currentUser = data;

            appendLog('âœ… ë¡œê·¸ì¸ ì„±ê³µ: userId=' + data.id + ', nickname=' + data.nickname);
            appendMessage('ì‹œìŠ¤í…œ', 'âœ… ë¡œê·¸ì¸ ì„±ê³µ! ë‹‰ë„¤ì„: ' + data.nickname, 'darkgreen');

            // UI ì—…ë°ì´íŠ¸
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('userInfo').style.display = 'block';
            document.getElementById('userNickname').innerText = data.nickname;

            // ì‚¬ìš©ì ID ìë™ ì„¤ì • (ì„ íƒì‚¬í•­)
            document.getElementById('senderId').value = data.id;
        })
        .catch(error => {
            appendLog('âŒ ë¡œê·¸ì¸ ì‹¤íŒ¨: ' + error.message);
            appendMessage('ì‹œìŠ¤í…œ', 'âŒ ë¡œê·¸ì¸ ì‹¤íŒ¨: ' + error.message, 'red');
        });
    }

    /**
     * ë¡œê·¸ì•„ì›ƒ
     */
    function logout() {
        currentJwtToken = null;
        currentUser = null;

        // ì—°ê²°ëœ ê²½ìš° ì—°ê²° í•´ì œ
        if (stompClient && stompClient.connected) {
            disconnect();
        }

        // UI ì—…ë°ì´íŠ¸
        document.getElementById('loginSection').style.display = 'block';
        document.getElementById('userInfo').style.display = 'none';
        document.getElementById('jwtTokenLogin').value = '';

        appendMessage('ì‹œìŠ¤í…œ', 'ğŸ‘‹ ë¡œê·¸ì•„ì›ƒ í–ˆìŠµë‹ˆë‹¤.', 'orange');
        log.info('ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ');
    }

    function connect() {
        // ë¡œê·¸ì¸ í™•ì¸
        if (!currentJwtToken) {
            alert('ë¨¼ì € ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”');
            appendMessage('ì‹œìŠ¤í…œ', 'âŒ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤', 'red');
            return;
        }

        currentRoomId = document.getElementById('roomId').value;  // âœ… ì „ì—­ ë³€ìˆ˜ì— í• ë‹¹
        currentSenderId = document.getElementById('senderId').value;  // âœ… ì „ì—­ ë³€ìˆ˜ì— í• ë‹¹

        appendMessage('ì‹œìŠ¤í…œ', 'âœï¸ ì—°ê²° ì‹œë„ ì¤‘...', 'orange');
        appendLog('ğŸ”Œ WebSocket ì—°ê²° ì‹œë„: ws://localhost:8081/ws-stomp');

        // 1. STOMP í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
        const clientConfig = {
            brokerURL: 'ws://localhost:8081/ws-stomp',
            connectHeaders: {
                'Authorization': 'Bearer ' + currentJwtToken
            },
            debug: function (str) {
                console.log('[STOMP DEBUG] ' + str);
                appendLog('STOMP: ' + str);
            },
            reconnectDelay: 5000,
            heartbeatIncoming: 4000,
            heartbeatOutgoing: 4000,
        };

        appendLog('ğŸ” JWT í† í° ì ìš©: ' + currentUser.nickname);

        stompClient = new StompJs.Client(clientConfig);

        stompClient.onConnect = function (frame) {
            console.log('âœ… ì—°ê²° ì„±ê³µ: ' + frame);
            updateStatus(true);
            appendMessage('ì‹œìŠ¤í…œ', 'âœ… ì„œë²„ì— ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤! (ë°© ë²ˆí˜¸: ' + currentRoomId + ')', 'darkgreen');
            appendLog('âœ… WebSocket ì—°ê²° ì„±ê³µ');

            // 2. ì±„íŒ…ë°© êµ¬ë… (Subscribe)
            const destination = '/topic/chat/room/' + currentRoomId;  // âœ… /topicìœ¼ë¡œ ë³€ê²½
            console.log('ğŸ“¡ êµ¬ë… ì‹œì‘: ' + destination);
            appendLog('ğŸ“¡ êµ¬ë… ì‹œì‘: ' + destination);
            appendMessage('ì‹œìŠ¤í…œ', 'ğŸ“¡ êµ¬ë… ì¤‘: ' + destination, 'blue');

            stompClient.subscribe(destination, function (chatMessage) {
                try {
                    appendLog('ğŸ“¥ WebSocket ë©”ì‹œì§€ ë„ì°©!');
                    console.log('ğŸ“¥ Raw message:', chatMessage);

                    const data = JSON.parse(chatMessage.body);
                    console.log('ğŸ“¨ íŒŒì‹±ëœ ë©”ì‹œì§€:', data);
                    appendLog('ğŸ“¨ íŒŒì‹± ì„±ê³µ: ' + JSON.stringify(data));

                    const messageContent = data.message || data.content;  // âœ… messageì™€ content ëª¨ë‘ ì§€ì›
                    const isMyMsg = String(data.senderId) === String(currentSenderId);  // âœ… currentSenderId ì‚¬ìš©
                    appendLog('ğŸ‘¤ ë°œì†¡ì: ' + (data.senderName || data.senderId) + ', ë‚´ìš©: ' + messageContent);
                    appendLog('âœ… ì±„íŒ…ì°½ì— í‘œì‹œ ì¤‘...');

                    appendMessage(data.senderName || data.senderId, messageContent, isMyMsg ? 'blue' : 'green');

                    appendLog('âœ… ë©”ì‹œì§€ í‘œì‹œ ì™„ë£Œ!');
                } catch (e) {
                    console.error('âŒ ë©”ì‹œì§€ íŒŒì‹± ì˜¤ë¥˜:', e);
                    appendLog('âŒ ë©”ì‹œì§€ íŒŒì‹± ì˜¤ë¥˜: ' + e.message);
                    appendLog('âŒ Raw body: ' + chatMessage.body);
                    appendMessage('ì˜¤ë¥˜', 'ë©”ì‹œì§€ íŒŒì‹± ì˜¤ë¥˜: ' + e.message, 'red');
                }
            });

            // (ì„ íƒ) ì…ì¥ ë©”ì‹œì§€ ë°œì†¡
            sendEnterMessage(currentRoomId, currentSenderId);
        };

        stompClient.onStompError = function (frame) {
            console.error('âŒ STOMP ì—ëŸ¬:', frame);
            appendLog('âŒ STOMP ì—ëŸ¬: ' + (frame.headers['message'] || frame));
            appendMessage('ì—ëŸ¬', 'STOMP ì—ëŸ¬: ' + (frame.headers['message'] || frame), 'red');
        };

        stompClient.onWebSocketError = function (event) {
            console.error('âŒ WebSocket ì—ëŸ¬:', event);
            appendLog('âŒ WebSocket ì—ëŸ¬ ë°œìƒ');
            appendMessage('ì—ëŸ¬', 'WebSocket ì—°ê²° ì‹¤íŒ¨!', 'red');
        };

        stompClient.onDisconnect = function (frame) {
            console.log('âš ï¸ ì—°ê²° í•´ì œ:', frame);
            appendLog('âš ï¸ ì—°ê²° í•´ì œë¨');
            appendMessage('ì‹œìŠ¤í…œ', 'âš ï¸ ì„œë²„ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤.', 'red');
            updateStatus(false);
        };

        console.log('ğŸ”Œ WebSocket í™œì„±í™” ì¤‘...');
        appendLog('ğŸ”Œ WebSocket í™œì„±í™” ì¤‘...');
        stompClient.activate();
    }

    function disconnect() {
        if (stompClient !== null && stompClient.connected) {
            stompClient.deactivate();
            updateStatus(false);
            appendMessage('ì‹œìŠ¤í…œ', 'âœ‚ï¸ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤.', 'red');
        } else {
            appendMessage('ì‹œìŠ¤í…œ', 'âŒ ì—°ê²°ëœ ìƒíƒœê°€ ì•„ë‹™ë‹ˆë‹¤.', 'red');
        }
    }

    function sendMessage() {
        if (!stompClient || !stompClient.connected) {
            alert("âŒ ë¨¼ì € ì ‘ì†í•´ì£¼ì„¸ìš”!");
            appendMessage('ì‹œìŠ¤í…œ', 'âŒ ì„œë²„ì— ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.', 'red');
            return;
        }

        const msgInput = document.getElementById('message');
        const messageText = msgInput.value.trim();

        if (!messageText) {
            alert("âŒ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!");
            return;
        }

        // 3. ë©”ì‹œì§€ ë°œí–‰ (Publish)
        const chatMessage = {
            type: 'TEXT',
            roomId: Number(currentRoomId),  // âœ… currentRoomId ì‚¬ìš©
            content: messageText
        };

        console.log('ğŸ“¤ ë©”ì‹œì§€ ë°œì†¡ ì •ë³´:');
        console.log('  - ëª©í‘œ ê²½ë¡œ: /app/chat/send');
        console.log('  - ë©”ì‹œì§€ ê°ì²´:', chatMessage);
        appendLog('ğŸ“¤ ë©”ì‹œì§€ ë°œì†¡: ' + messageText);

        try {
            console.log('ğŸš€ stompClient.publish() í˜¸ì¶œ');
            appendLog('ğŸš€ stompClient.publish() í˜¸ì¶œ');
            stompClient.publish({
                destination: '/app/chat/send',
                body: JSON.stringify(chatMessage)
            });
            console.log('âœ… stompClient.publish() ì™„ë£Œ');
            appendLog('âœ… stompClient.publish() ì™„ë£Œ');
            msgInput.value = '';
        } catch (e) {
            console.error('âŒ ë©”ì‹œì§€ ë°œì†¡ ì˜¤ë¥˜:', e);
            appendLog('âŒ ë©”ì‹œì§€ ë°œì†¡ ì˜¤ë¥˜: ' + e.message);
            appendMessage('ì˜¤ë¥˜', 'ë©”ì‹œì§€ ë°œì†¡ ì‹¤íŒ¨: ' + e.message, 'red');
        }
    }

    function sendEnterMessage(roomId, senderId) {
        const chatMessage = {
            type: 'ENTER',
            roomId: Number(roomId),
            content: 'ì±„íŒ…ë°©ì— ì…ì¥í–ˆìŠµë‹ˆë‹¤.'  // âœ… "message"ì—ì„œ "content"ë¡œ ë³€ê²½
        };

        console.log('ğŸ“¤ ì…ì¥ ë©”ì‹œì§€ ë°œì†¡:', chatMessage);
        try {
            stompClient.publish({
                destination: '/app/chat/send',
                body: JSON.stringify(chatMessage)
            });
        } catch (e) {
            console.error('âŒ ì…ì¥ ë©”ì‹œì§€ ë°œì†¡ ì˜¤ë¥˜:', e);
        }
    }

    function appendMessage(sender, message, color) {
        const chatBox = document.getElementById('chat-box');
        const msgDiv = document.createElement('div');
        msgDiv.className = 'msg';
        msgDiv.style.color = color;
        msgDiv.style.fontSize = '12px';
        msgDiv.innerText = `[${new Date().toLocaleTimeString()}] [${sender}] ${message}`;
        chatBox.appendChild(msgDiv);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    function appendLog(message) {
        const logBox = document.getElementById('log-box');
        const logDiv = document.createElement('div');
        const timestamp = new Date().toLocaleTimeString();
        logDiv.innerText = `[${timestamp}] ${message}`;
        logDiv.style.color = '#0f0';  // ì´ˆë¡ìƒ‰
        logBox.appendChild(logDiv);
        logBox.scrollTop = logBox.scrollHeight;
    }

    function clearLogs() {
        const logBox = document.getElementById('log-box');
        logBox.innerHTML = '';
        appendLog('ë¡œê·¸ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
    }

    function updateStatus(connected) {
        const statusDiv = document.getElementById('status');
        if (connected) {
            statusDiv.className = 'connected';
            statusDiv.innerText = 'âœ… ì—°ê²°ë¨';
        } else {
            statusDiv.className = 'disconnected';
            statusDiv.innerText = 'âŒ ì—°ê²° ì•ˆ ë¨';
        }
    }
</script>
</body>
</html>
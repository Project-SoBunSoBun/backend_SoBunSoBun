<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì±„íŒ… í…ŒìŠ¤íŠ¸ - WebSocket STOMP</title>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        h1 { color: #333; margin-top: 0; }
        .section {
            background: #f9f9f9;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        label {
            display: block;
            margin: 15px 0 5px 0;
            font-weight: bold;
            color: #555;
        }
        input, textarea {
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            font-family: inherit;
        }
        textarea { resize: vertical; height: 60px; }
        button {
            padding: 12px 20px;
            margin: 5px 5px 5px 0;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            background: #667eea;
            color: white;
            font-size: 14px;
        }
        button:hover { background: #5568d3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .status {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-weight: bold;
            text-align: center;
        }
        .status.connected { background: #d4edda; color: #155724; border: 2px solid #28a745; }
        .status.disconnected { background: #f8d7da; color: #721c24; border: 2px solid #dc3545; }
        .log {
            background: #1e1e1e;
            color: #0f0;
            padding: 15px;
            border-radius: 5px;
            height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            margin-top: 10px;
        }
        .log-entry { margin: 3px 0; border-bottom: 1px solid #333; }
        .log-success { color: #0f0; }
        .log-error { color: #f44; }
        .log-info { color: #0ff; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ ì±„íŒ… WebSocket í…ŒìŠ¤íŠ¸</h1>
        <div id="status" class="status disconnected">âŒ ì—°ê²° ì•ˆë¨</div>

        <div class="section">
            <h2>âš™ï¸ ì—°ê²° ì„¤ì •</h2>
            <label>SockJS ì—”ë“œí¬ì¸íŠ¸:</label>
            <input type="text" id="wsUrl" value="http://localhost:8081/ws/chat">
            <label>ì¸ì¦ í† í°:</label>
            <input type="text" id="token" placeholder="Bearer token ì…ë ¥ (ì„ íƒì‚¬í•­)">
            <button onclick="connect()">ğŸ”Œ ì—°ê²°</button>
            <button onclick="disconnect()">âŒ ì—°ê²° í•´ì œ</button>
        </div>

        <div class="section">
            <h2>ğŸ“¡ ì±„íŒ…ë°© êµ¬ë…</h2>
            <label>ì±„íŒ…ë°© ID:</label>
            <input type="text" id="roomId" value="1">
            <button onclick="subscribe()">ğŸ“¡ êµ¬ë…</button>
            <button onclick="unsubscribe()">âŒ êµ¬ë… ì·¨ì†Œ</button>
        </div>

        <div class="section">
            <h2>ğŸ“‹ ì•ˆ ì½ì€ ë©”ì‹œì§€ ëª©ë¡</h2>
            <button onclick="loadChatRoomList()">ğŸ”„ ì±„íŒ…ë°© ëª©ë¡ ìƒˆë¡œê³ ì¹¨</button>
            <div id="chatRoomList" style="margin-top: 20px; background: white; padding: 15px; border-radius: 5px; border: 1px solid #ddd;"></div>
        </div>

        <div class="section">
            <h2>ğŸ’¬ ë©”ì‹œì§€ ì „ì†¡</h2>
            <label>ë©”ì‹œì§€:</label>
            <textarea id="messageContent" placeholder="ë©”ì‹œì§€ ì…ë ¥ (í•œê¸€ ê°€ëŠ¥)"></textarea>
            <button onclick="sendMessage()">ğŸ“¤ ì „ì†¡</button>
        </div>

        <div class="section">
            <h2>ğŸ“– ì½ìŒ ì²˜ë¦¬</h2>
            <label>ë§ˆì§€ë§‰ìœ¼ë¡œ ì½ì€ ë©”ì‹œì§€ ID:</label>
            <input type="text" id="lastReadMessageId" placeholder="ë©”ì‹œì§€ ID ì…ë ¥ (ì˜ˆ: 5)">
            <button onclick="markAsRead()">âœ… ì½ìŒ ì²˜ë¦¬</button>
        </div>

        <div class="section">
            <h2>ğŸ“‹ ë¡œê·¸</h2>
            <button onclick="clearLog()">ğŸ—‘ï¸ ì§€ìš°ê¸°</button>
            <div id="log" class="log"></div>
        </div>
    </div>

    <script>
        let client = null;
        let connected = false;
        let subscription = null;

        function log(message, type = 'info') {
            console.log(`[${type}] ${message}`);
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            const timestamp = new Date().toLocaleTimeString('ko-KR');
            entry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
            log('ğŸ“‹ ë¡œê·¸ ì´ˆê¸°í™”ë¨', 'info');
        }

        function updateStatus(isConnected) {
            connected = isConnected;
            const statusDiv = document.getElementById('status');
            if (isConnected) {
                statusDiv.className = 'status connected';
                statusDiv.textContent = 'âœ… ì—°ê²°ë¨';
            } else {
                statusDiv.className = 'status disconnected';
                statusDiv.textContent = 'âŒ ì—°ê²° ì•ˆë¨';
            }
        }

        function connect() {
            try {
                const wsUrl = document.getElementById('wsUrl').value;
                const token = document.getElementById('token').value || 'test-token';

                if (!wsUrl) {
                    log('âŒ SockJS ì—”ë“œí¬ì¸íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”', 'error');
                    return;
                }

                log(`ğŸ”Œ ì—°ê²° ì‹œë„: ${wsUrl}`, 'info');
                log(`ğŸ“‹ Token: ${token}`, 'info');

                const socket = new SockJS(wsUrl);
                client = Stomp.over(socket);

                // STOMP ë””ë²„ê·¸ ëª¨ë“œ ë¹„í™œì„±í™” - DEBUG ë¡œê·¸ ì œê±°
                // client.debug = function(msg) {
                //     log(`[STOMP DEBUG] ${msg}`, 'info');
                // };

                client.connect(
                    { 'Authorization': `Bearer ${token}` },
                    function(frame) {
                        log('âœ… STOMP ì—°ê²° ì„±ê³µ!', 'success');
                        log(`Frame: ${frame.command}`, 'success');
                        updateStatus(true);

                        // âœ… ê°œì¸ í êµ¬ë… (ì½ìŒ ì²˜ë¦¬ ì‘ë‹µ ìˆ˜ì‹ )
                        client.subscribe('/user/queue/private', function(message) {
                            try {
                                const data = JSON.parse(message.body);
                                if (data.type === 'READ_COMPLETE') {
                                    log(`âœ… ì½ìŒ ì²˜ë¦¬ ì‘ë‹µ: ${data.message}`, 'success');
                                    log(`ğŸ“‹ ì±„íŒ…ë°© ${data.roomId}ì˜ unreadCountê°€ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.`, 'success');
                                } else {
                                    log(`ğŸ“© ê°œì¸ ë©”ì‹œì§€: ${data.message}`, 'info');
                                }
                            } catch (e) {
                                log(`ğŸ“© ${message.body}`, 'info');
                            }
                        });
                    },
                    function(error) {
                        log(`âŒ ì—°ê²° ì‹¤íŒ¨: ${error}`, 'error');
                        console.error('STOMP connection error:', error);
                        updateStatus(false);
                    }
                );

            } catch (error) {
                log(`âŒ ì˜ˆì™¸: ${error.message}`, 'error');
                console.error('Exception:', error);
            }
        }

        function disconnect() {
            try {
                if (client && client.connected) {
                    client.disconnect(function() {
                        log('âœ… ì—°ê²° í•´ì œë¨', 'info');
                        updateStatus(false);
                    });
                } else {
                    log('âŒ ì—°ê²°ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤', 'error');
                }
            } catch (error) {
                log(`âŒ ì—ëŸ¬: ${error.message}`, 'error');
            }
        }

        function subscribe() {
            try {
                if (!client || !client.connected) {
                    log('âŒ ë¨¼ì € ì—°ê²°í•˜ì„¸ìš”', 'error');
                    return;
                }

                const roomId = document.getElementById('roomId').value;
                if (!roomId) {
                    log('âŒ ì±„íŒ…ë°© IDë¥¼ ì…ë ¥í•˜ì„¸ìš”', 'error');
                    return;
                }

                const destination = `/topic/rooms/${roomId}`;

                if (subscription) {
                    subscription.unsubscribe();
                }

                subscription = client.subscribe(destination, function(message) {
                    try {
                        const body = JSON.parse(message.body);
                        log(`ğŸ“© ë©”ì‹œì§€ ìˆ˜ì‹ : ${body.content || message.body}`, 'success');
                    } catch (e) {
                        log(`ğŸ“© ${message.body}`, 'success');
                    }
                });

                log(`âœ… êµ¬ë… ì„±ê³µ: ${destination}`, 'success');

                // êµ¬ë… í›„ ê³¼ê±° ë©”ì‹œì§€ ë¶ˆëŸ¬ì˜¤ê¸°
                loadHistoryMessages(roomId);

            } catch (error) {
                log(`âŒ êµ¬ë… ì—ëŸ¬: ${error.message}`, 'error');
            }
        }

        // ê³¼ê±° ë©”ì‹œì§€ ë¶ˆëŸ¬ì˜¤ê¸° ë° ìë™ ì½ìŒ ì²˜ë¦¬
        function loadHistoryMessages(roomId) {
            try {
                const apiUrl = `http://localhost:8081/api/v1/chat/rooms/${roomId}/messages?page=0&size=50`;

                log(`ğŸ“¥ ê³¼ê±° ë©”ì‹œì§€ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...`, 'info');

                let tokenValue = document.getElementById('token').value || 'test-token';
                // Bearerê°€ ì—†ìœ¼ë©´ ì¶”ê°€, ìˆìœ¼ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©
                if (!tokenValue.startsWith('Bearer ')) {
                    tokenValue = 'Bearer ' + tokenValue;
                }

                fetch(apiUrl, {
                    method: 'GET',
                    headers: {
                        'Authorization': tokenValue,
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    // data.dataê°€ PageImpl í˜•íƒœ ë˜ëŠ” ì§ì ‘ content ë°°ì—´
                    let messages = [];

                    if (data.data && Array.isArray(data.data.content)) {
                        messages = data.data.content;
                    } else if (Array.isArray(data.data)) {
                        messages = data.data;
                    } else if (data.content) {
                        messages = data.content;
                    }

                    if (messages.length > 0) {
                        log(`ğŸ“¥ ${messages.length}ê°œì˜ ê³¼ê±° ë©”ì‹œì§€ ë¶ˆëŸ¬ì˜´`, 'info');

                        // ì‹œê°„ìˆœìœ¼ë¡œ ì •ë ¬ (ì˜¤ë˜ëœìˆœ)
                        messages.reverse().forEach(msg => {
                            log(`ğŸ“œ [ì´ì „] ${msg.senderName}: ${msg.content}`, 'info');
                        });

                        // âœ… ìë™ ì½ìŒ ì²˜ë¦¬: ë§ˆì§€ë§‰ ë©”ì‹œì§€ IDë¡œ ì½ìŒ í‘œì‹œ (ì¦‰ì‹œ ì²˜ë¦¬)
                        const lastMessage = messages[messages.length - 1];
                        if (lastMessage && lastMessage.id) {
                            log(`ğŸ“– êµ¬ë… ì™„ë£Œ - ìë™ ì½ìŒ ì²˜ë¦¬: ë©”ì‹œì§€ ID ${lastMessage.id}`, 'info');

                            // ìë™ ì½ìŒ ì²˜ë¦¬ ì‹¤í–‰ (ì§€ì—° ì—†ìŒ - ë°”ë¡œ ì²˜ë¦¬)
                            autoMarkAsRead(roomId, lastMessage.id);
                        }
                    } else {
                        log(`âš ï¸ ê³¼ê±° ë©”ì‹œì§€ ì—†ìŒ`, 'info');
                    }
                })
                .catch(error => {
                    log(`âš ï¸ ê³¼ê±° ë©”ì‹œì§€ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${error.message}`, 'error');
                    console.error('History load error:', error);
                });

            } catch (error) {
                log(`âŒ ì—ëŸ¬: ${error.message}`, 'error');
            }
        }

        // âœ… ìë™ ì½ìŒ ì²˜ë¦¬ í•¨ìˆ˜ (ì±„íŒ…ë°© ì…ì¥ ì‹œ í˜¸ì¶œ)
        function autoMarkAsRead(roomId, lastReadMessageId) {
            try {
                if (!client || !client.connected) {
                    log('âŒ ì•„ì§ ì—°ê²°ë˜ì§€ ì•ŠìŒ - ì½ìŒ ì²˜ë¦¬ ìŠ¤í‚µ', 'warn');
                    return;
                }

                const payload = {
                    roomId: parseInt(roomId),
                    lastReadMessageId: parseInt(lastReadMessageId)
                };

                client.send('/app/chat/read', {}, JSON.stringify(payload));
                log(`âœ… ìë™ ì½ìŒ ì²˜ë¦¬ ì™„ë£Œ - messageId: ${lastReadMessageId}`, 'success');

            } catch (error) {
                log(`âš ï¸ ìë™ ì½ìŒ ì²˜ë¦¬ ì‹¤íŒ¨: ${error.message}`, 'warn');
            }
        }

        function unsubscribe() {
            try {
                if (subscription) {
                    subscription.unsubscribe();
                    log('âœ… êµ¬ë… ì·¨ì†Œë¨', 'info');
                    subscription = null;
                } else {
                    log('âŒ êµ¬ë… ì¤‘ì¸ ì±„íŒ…ë°©ì´ ì—†ìŠµë‹ˆë‹¤', 'error');
                }
            } catch (error) {
                log(`âŒ ì—ëŸ¬: ${error.message}`, 'error');
            }
        }

        function sendMessage() {
            try {
                if (!client || !client.connected) {
                    log('âŒ ë¨¼ì € ì—°ê²°í•˜ì„¸ìš”', 'error');
                    return;
                }

                const roomId = document.getElementById('roomId').value;
                const content = document.getElementById('messageContent').value;

                if (!roomId) {
                    log('âŒ ì±„íŒ…ë°© IDë¥¼ ì…ë ¥í•˜ì„¸ìš”', 'error');
                    return;
                }

                if (!content) {
                    log('âŒ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”', 'error');
                    return;
                }

                const payload = {
                    roomId: parseInt(roomId),
                    type: 'TEXT',
                    content: content
                };

                log(`ğŸ“¤ ë©”ì‹œì§€ ì „ì†¡: ${content}`, 'info');

                client.send('/app/chat/send', {}, JSON.stringify(payload));

                log('âœ… ì „ì†¡ ì™„ë£Œ', 'success');
                document.getElementById('messageContent').value = '';

            } catch (error) {
                log(`âŒ ì „ì†¡ ì—ëŸ¬: ${error.message}`, 'error');
            }
        }

        // ì±„íŒ…ë°© ëª©ë¡ ì¡°íšŒ (ì•ˆ ì½ì€ ë©”ì‹œì§€ í¬í•¨)
        function loadChatRoomList() {
            try {
                const apiUrl = `http://localhost:8081/api/v1/chat/rooms?page=0&size=20`;

                log(`ğŸ“‹ ì±„íŒ…ë°© ëª©ë¡ ì¡°íšŒ ì¤‘...`, 'info');

                let tokenValue = document.getElementById('token').value || 'test-token';
                if (!tokenValue.startsWith('Bearer ')) {
                    tokenValue = 'Bearer ' + tokenValue;
                }

                fetch(apiUrl, {
                    method: 'GET',
                    headers: {
                        'Authorization': tokenValue,
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    const chatRoomList = document.getElementById('chatRoomList');
                    chatRoomList.innerHTML = '';

                    if (!data.content || data.content.length === 0) {
                        chatRoomList.innerHTML = '<p style="color: #999;">ì±„íŒ…ë°©ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                        log('ğŸ“‹ ì±„íŒ…ë°© ì—†ìŒ', 'info');
                        return;
                    }

                    log(`ğŸ“‹ ${data.content.length}ê°œì˜ ì±„íŒ…ë°© ì¡°íšŒë¨`, 'success');

                    // ì±„íŒ…ë°© ëª©ë¡ ë Œë”ë§
                    data.content.forEach(room => {
                        const roomDiv = document.createElement('div');
                        roomDiv.style.cssText = 'padding: 12px; margin-bottom: 10px; background: #f5f5f5; border-radius: 5px; border-left: 3px solid #667eea;';

                        const unreadBadge = room.unreadCount > 0
                            ? `<span style="background: #ff6b6b; color: white; padding: 2px 8px; border-radius: 12px; font-weight: bold; margin-left: 10px;">${room.unreadCount}ê°œ</span>`
                            : '<span style="color: #999; margin-left: 10px;">ì½ìŒ</span>';

                        roomDiv.innerHTML = `
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong>${room.name}</strong>
                                    <div style="color: #666; font-size: 12px; margin-top: 3px;">${room.lastMessagePreview}</div>
                                </div>
                                ${unreadBadge}
                            </div>
                        `;

                        chatRoomList.appendChild(roomDiv);

                        // ë¡œê·¸ ì¶œë ¥
                        const unreadText = room.unreadCount > 0 ? `[ì•ˆì½ìŒ: ${room.unreadCount}ê°œ]` : '[ì½ìŒ]';
                        log(`  ğŸ“± ${room.name}: ${unreadText}`, 'info');
                    });

                })
                .catch(error => {
                    log(`âš ï¸ ì±„íŒ…ë°© ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨: ${error.message}`, 'error');
                    console.error('List load error:', error);
                    const chatRoomList = document.getElementById('chatRoomList');
                    chatRoomList.innerHTML = `<p style="color: #f44;">ì¡°íšŒ ì‹¤íŒ¨: ${error.message}</p>`;
                });

            } catch (error) {
                log(`âŒ ì—ëŸ¬: ${error.message}`, 'error');
            }
        }

        // ì½ìŒ ì²˜ë¦¬
        function markAsRead() {
            try {
                if (!client || !client.connected) {
                    log('âŒ ë¨¼ì € ì—°ê²°í•˜ì„¸ìš”', 'error');
                    return;
                }

                const roomId = document.getElementById('roomId').value;
                const lastReadMessageId = document.getElementById('lastReadMessageId').value;

                if (!roomId) {
                    log('âŒ ì±„íŒ…ë°© IDë¥¼ ì…ë ¥í•˜ì„¸ìš”', 'error');
                    return;
                }

                if (!lastReadMessageId) {
                    log('âŒ ë§ˆì§€ë§‰ ì½ì€ ë©”ì‹œì§€ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”', 'error');
                    return;
                }

                const payload = {
                    roomId: parseInt(roomId),
                    lastReadMessageId: parseInt(lastReadMessageId)
                };

                log(`ğŸ“– ì½ìŒ ì²˜ë¦¬ ì „ì†¡: roomId=${roomId}, messageId=${lastReadMessageId}`, 'info');

                client.send('/app/chat/read', {}, JSON.stringify(payload));

                log('âœ… ì½ìŒ ì²˜ë¦¬ ì™„ë£Œ', 'success');

                // 1ì´ˆ í›„ ì±„íŒ…ë°© ëª©ë¡ ìë™ ìƒˆë¡œê³ ì¹¨
                setTimeout(() => {
                    log('ğŸ”„ ì±„íŒ…ë°© ëª©ë¡ ìë™ ê°±ì‹  ì¤‘...', 'info');
                    loadChatRoomList();
                }, 1000);

            } catch (error) {
                log(`âŒ ì½ìŒ ì²˜ë¦¬ ì—ëŸ¬: ${error.message}`, 'error');
            }
        }

        window.addEventListener('load', function() {
            log('ğŸ¯ ì±„íŒ… í…ŒìŠ¤íŠ¸ ì¤€ë¹„ ì™„ë£Œ', 'info');
            log('ğŸ’¡ 1. ì—°ê²° â†’ 2. êµ¬ë… â†’ 3. ë©”ì‹œì§€ ì „ì†¡ ìˆœì„œë¡œ ì§„í–‰í•˜ì„¸ìš”', 'info');
        });
    </script>
</body>
</html>

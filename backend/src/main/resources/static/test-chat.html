<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>ì±„íŒ… í…ŒìŠ¤íŠ¸ - 2 í´ë¼ì´ì–¸íŠ¸</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            overflow: hidden; /* í˜ì´ì§€ ìì²´ ìŠ¤í¬ë¡¤ ì œê±° */
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #f0f0f0;
            display: flex;
            flex-direction: column;
        }

        /* ìƒë‹¨ í† í° ì…ë ¥ íŒ¨ë„ */
        .top-input-panel {
            flex: 0 0 auto;
            padding: 10px 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #ddd;
        }
        .top-input-panel h3 {
            margin: 0 0 6px 0;
            font-size: 14px;
            color: #333;
        }
        .top-input-panel input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 6px;
            font-size: 13px;
        }
        .top-input-panel button {
            width: 100%;
            padding: 8px;
            background: #3b5998;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: bold;
        }
        .top-input-panel button:hover {
            background: #2d4373;
        }

        /* ë©”ì¸ ì˜ì—­: ì¢Œìš° 2 í´ë¼ì´ì–¸íŠ¸ */
        .container {
            flex: 1 1 auto;
            display: flex;
            gap: 2px;
            height: 100%;
            overflow: hidden; /* ë‚´ë¶€ì—ì„œë§Œ ìŠ¤í¬ë¡¤ ë‚˜ë„ë¡ */
        }

        .client-wrapper {
            flex: 1;
            display: flex;
            background: white;
            position: relative;
        }

        /* ì±„íŒ…ë°© ëª©ë¡ í˜ì´ì§€ */
        .room-list-page {
            position: absolute;
            inset: 0;
            background: white;
            display: flex;
            flex-direction: column;
        }
        .room-list-page.hidden {
            display: none; /* ë°©ì— ë“¤ì–´ê°€ë©´ ëª©ë¡ì€ ì•ˆ ë³´ì´ê²Œ */
        }

        /* ì±„íŒ…ë°© í˜ì´ì§€ */
        .chat-page {
            position: absolute;
            inset: 0;
            background: white;
            display: none;
            flex-direction: column;
        }
        .chat-page.active {
            display: flex;
        }

        .page-header {
            padding: 10px 12px;
            background: #3b5998;
            color: white;
            font-weight: bold;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 0 0 auto;
        }

        .back-button {
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            padding: 0;
            width: 26px;
            height: 26px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .back-button:hover {
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
        }

        .page-title {
            flex: 1;
        }

        .status {
            padding: 5px 8px;
            font-size: 11px;
            text-align: center;
            background: #fff3cd;
            border-bottom: 1px solid #ffc107;
            flex: 0 0 auto;
        }
        .status.connected {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }
        .status.error {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }

        .room-list-controls {
            padding: 8px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
            flex: 0 0 auto;
        }
        .room-list-controls button {
            width: 100%;
            padding: 6px;
            background: #3b5998;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-bottom: 4px;
        }
        .room-list-controls button:hover {
            background: #2d4373;
        }

        .room-items {
            flex: 1 1 auto;
            overflow-y: auto;
        }

        .room-item {
            padding: 10px 12px;
            border-bottom: 1px solid #e0e0e0;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 13px;
        }
        .room-item:hover {
            background: #f5f5f5;
        }
        .room-item.active {
            background: #e3f2fd;
        }
        .room-item-title {
            font-weight: 600;
            margin-bottom: 4px;
            font-size: 13px;
        }
        .room-item-info {
            font-size: 11px;
            color: #666;
        }

        /* ì±„íŒ… ë©”ì‹œì§€ ì˜ì—­ */
        .messages {
            flex: 1 1 auto;
            overflow-y: auto;
            padding: 12px;
            background: #ffffff;
        }
        .message {
            margin-bottom: 10px;
            display: flex;
            align-items: flex-start;
        }
        .message.mine {
            flex-direction: row-reverse; /* ë‚´ ë©”ì‹œì§€ëŠ” ì˜¤ë¥¸ìª½ */
        }
        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 14px;
            flex-shrink: 0;
            overflow: hidden;
        }
        .message-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .message-content {
            max-width: 70%;
            margin: 0 8px;
        }
        .message.mine .message-content {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }
        .message-sender {
            font-size: 11px;
            color: #666;
            margin-bottom: 3px;
        }
        .message.mine .message-sender {
            display: none;
        }
        .message-bubble {
            padding: 8px 11px;
            border-radius: 16px;
            background: #f0f0f0;
            display: inline-block;
            word-wrap: break-word;
            font-size: 13px;
        }
        .message.mine .message-bubble {
            background: #3b5998;
            color: white;
        }
        .message-time {
            font-size: 10px;
            color: #999;
            margin-top: 3px;
        }

        /* ë‚ ì§œ êµ¬ë¶„ì„  */
        .date-separator {
            display: flex;
            align-items: center;
            margin: 20px 0;
            text-align: center;
        }
        .date-separator::before,
        .date-separator::after {
            content: '';
            flex: 1;
            border-bottom: 1px solid #e0e0e0;
        }
        .date-separator-text {
            padding: 0 16px;
            font-size: 12px;
            color: #666;
            background: #f5f5f5;
            border-radius: 12px;
            padding: 4px 12px;
        }

        /* ì…ë ¥ ì˜ì—­ */
        .input-area {
            padding: 8px 10px;
            border-top: 1px solid #e0e0e0;
            background: white;
            display: flex;
            gap: 8px;
            flex: 0 0 auto;
        }
        .input-area input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 20px;
            font-size: 13px;
        }
        .input-area button {
            padding: 8px 16px;
            background: #3b5998;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            font-size: 13px;
        }
        .input-area button:hover {
            background: #2d4373;
        }
        .input-area button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* ë¡œê·¸ íŒ¨ë„ */
        .log-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 140px;
            background: #1e1e1e;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            padding: 8px;
            overflow-y: auto;
            display: none;
            z-index: 900;
        }
        .log-panel.show {
            display: block;
        }
        .toggle-log {
            position: fixed;
            bottom: 8px;
            right: 8px;
            padding: 6px 12px;
            background: #333;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            z-index: 1000;
            font-size: 11px;
        }
    </style>
</head>
<body>

<!-- ê³µí†µ ì…ë ¥ íŒ¨ë„ -->
<div class="top-input-panel">
    <h3>ğŸ”‘ ì¹´ì¹´ì˜¤ ì•¡ì„¸ìŠ¤ í† í° ì…ë ¥ (ì–‘ìª½ í´ë¼ì´ì–¸íŠ¸ ê³µí†µ)</h3>
    <input id="sharedToken" type="text" placeholder="ì¹´ì¹´ì˜¤ ì•¡ì„¸ìŠ¤ í† í°ì„ ì…ë ¥í•˜ì„¸ìš”" />
    <button onclick="loginBothClients()">ì–‘ìª½ í´ë¼ì´ì–¸íŠ¸ ë¡œê·¸ì¸</button>
</div>

<div class="container">
    <!-- Client A -->
    <div class="client-wrapper">
        <!-- ì±„íŒ…ë°© ëª©ë¡ í˜ì´ì§€ -->
        <div class="room-list-page" id="roomListPageA">
            <div class="page-header">
                <div class="page-title">í´ë¼ì´ì–¸íŠ¸ A - ì±„íŒ…ë°© ëª©ë¡</div>
            </div>
            <div class="status" id="statusA">í† í°ì„ ì…ë ¥í•˜ê³  ë¡œê·¸ì¸í•˜ì„¸ìš”</div>
            <div class="room-list-controls">
                <button onclick="clientA.loadRooms()">ì±„íŒ…ë°© ëª©ë¡ ìƒˆë¡œê³ ì¹¨</button>
                <button onclick="clientA.createRoom()">ìƒˆ ì±„íŒ…ë°© ë§Œë“¤ê¸°</button>
            </div>
            <div class="room-items" id="roomListA"></div>
        </div>

        <!-- ì±„íŒ…ë°© í˜ì´ì§€ -->
        <div class="chat-page" id="chatPageA">
            <div class="page-header">
                <button class="back-button" onclick="clientA.goBack()">â†</button>
                <div class="page-title" id="roomNameA">ì±„íŒ…ë°©</div>
            </div>
            <div class="messages" id="messagesA"></div>
            <div class="input-area">
                <input id="inputA" type="text" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”" disabled />
                <button id="sendBtnA" onclick="clientA.sendMessage()" disabled>ì „ì†¡</button>
            </div>
        </div>
    </div>

    <!-- Client B -->
    <div class="client-wrapper">
        <!-- ì±„íŒ…ë°© ëª©ë¡ í˜ì´ì§€ -->
        <div class="room-list-page" id="roomListPageB">
            <div class="page-header">
                <div class="page-title">í´ë¼ì´ì–¸íŠ¸ B - ì±„íŒ…ë°© ëª©ë¡</div>
            </div>
            <div class="status" id="statusB">í† í°ì„ ì…ë ¥í•˜ê³  ë¡œê·¸ì¸í•˜ì„¸ìš”</div>
            <div class="room-list-controls">
                <button onclick="clientB.loadRooms()">ì±„íŒ…ë°© ëª©ë¡ ìƒˆë¡œê³ ì¹¨</button>
                <button onclick="clientB.createRoom()">ìƒˆ ì±„íŒ…ë°© ë§Œë“¤ê¸°</button>
            </div>
            <div class="room-items" id="roomListB"></div>
        </div>

        <!-- ì±„íŒ…ë°© í˜ì´ì§€ -->
        <div class="chat-page" id="chatPageB">
            <div class="page-header">
                <button class="back-button" onclick="clientB.goBack()">â†</button>
                <div class="page-title" id="roomNameB">ì±„íŒ…ë°©</div>
            </div>
            <div class="messages" id="messagesB"></div>
            <div class="input-area">
                <input id="inputB" type="text" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”" disabled />
                <button id="sendBtnB" onclick="clientB.sendMessage()" disabled>ì „ì†¡</button>
            </div>
        </div>
    </div>
</div>

<button class="toggle-log" onclick="toggleLog()">ë¡œê·¸ í‘œì‹œ/ìˆ¨ê¹€</button>
<div class="log-panel" id="logPanel"></div>

<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
<script>
    const API_BASE = 'http://localhost:8080';

    // ë¡œê·¸ í•¨ìˆ˜
    function log(msg) {
        const panel = document.getElementById('logPanel');
        const time = new Date().toLocaleTimeString();
        panel.textContent += `[${time}] ${msg}\n`;
        panel.scrollTop = panel.scrollHeight;
    }

    function toggleLog() {
        document.getElementById('logPanel').classList.toggle('show');
    }

    class ChatClient {
        constructor(id, uiClientId) {
            this.id = id;                    // A / B
            this.uiClientId = uiClientId;    // 'A' / 'B' (ì¢Œìš° ê´€ì )
            this.token = null;
            this.stompClient = null;
            this.currentRoom = null;
            this.currentRoomId = null;
            this.rooms = [];
            this.userInfo = null;
            this.subscription = null;
            this.storageKey = `chat_token_${id}`;
            this.lastMessageDate = null;     // ë§ˆì§€ë§‰ ë©”ì‹œì§€ ë‚ ì§œ ì¶”ì 
        }

        // localStorageì—ì„œ í† í° ë¡œë“œ
        loadTokenFromStorage() {
            const stored = localStorage.getItem(this.storageKey);
            if (stored) {
                this.token = stored;
                log(`${this.id}: localStorageì—ì„œ í† í° ë¡œë“œë¨`);
                return true;
            }
            return false;
        }

        saveTokenToStorage() {
            if (this.token) {
                localStorage.setItem(this.storageKey, this.token);
                log(`${this.id}: localStorageì— í† í° ì €ì¥ë¨`);
            }
        }

        clearTokenFromStorage() {
            localStorage.removeItem(this.storageKey);
            log(`${this.id}: localStorageì—ì„œ í† í° ì‚­ì œë¨`);
        }

        setStatus(message, type = 'normal') {
            const status = document.getElementById(`status${this.id}`);
            status.textContent = message;
            status.className = 'status';
            if (type === 'connected') status.classList.add('connected');
            if (type === 'error') status.classList.add('error');
        }

        async login(kakaoToken) {
            try {
                this.setStatus('ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘...');
                log(`${this.id}: ë¡œê·¸ì¸ ì‹œì‘`);

                const res = await fetch(`${API_BASE}/auth/complete-signup`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        loginToken: kakaoToken,
                        serviceTermsAgreed: true,
                        privacyPolicyAgreed: true,
                        marketingOptionalAgreed: false
                    })
                });

                if (!res.ok) {
                    const error = await res.text();
                    throw new Error(`ë¡œê·¸ì¸ ì‹¤íŒ¨: ${error}`);
                }

                const data = await res.json();
                this.token = data.accessToken;
                this.myUserId = data.user?.id ?? this.getSenderIdFromToken();
                log(`${this.id}: JWT ë°œê¸‰ ì™„ë£Œ - ì‚¬ìš©ì ID: ${this.myUserId}`);

                this.saveTokenToStorage();

                await this.loadRooms();
                await this.connectWebSocket();
                this.setStatus('ì—°ê²°ë¨', 'connected');
                log(`${this.id}: ë¡œê·¸ì¸ ì„±ê³µ`);

            } catch (error) {
                this.setStatus('ë¡œê·¸ì¸ ì‹¤íŒ¨', 'error');
                log(`${this.id}: ë¡œê·¸ì¸ ì‹¤íŒ¨ - ${error}`);
                throw error;
            }
        }

        async autoLogin() {
            if (this.loadTokenFromStorage()) {
                try {
                    this.myUserId = this.getSenderIdFromToken();
                    this.setStatus('ìë™ ë¡œê·¸ì¸ ì¤‘...');
                    await this.loadRooms();
                    await this.connectWebSocket();
                    this.setStatus('ì—°ê²°ë¨ (ìë™)', 'connected');
                    log(`${this.id}: ìë™ ë¡œê·¸ì¸ ì„±ê³µ`);
                    return true;
                } catch (error) {
                    this.setStatus('í† í° ë§Œë£Œ - ë‹¤ì‹œ ë¡œê·¸ì¸í•˜ì„¸ìš”', 'error');
                    log(`${this.id}: ìë™ ë¡œê·¸ì¸ ì‹¤íŒ¨ - ${error}`);
                    this.clearTokenFromStorage();
                    return false;
                }
            }
            return false;
        }

        async loadRooms() {
            if (!this.token) {
                alert('ë¨¼ì € ë¡œê·¸ì¸í•˜ì„¸ìš”');
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/api/chat/rooms`, {
                    headers: { 'Authorization': `Bearer ${this.token}` }
                });

                if (!res.ok) throw new Error('ì±„íŒ…ë°© ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨');

                this.rooms = await res.json();
                this.renderRoomList();
                log(`${this.id}: ì±„íŒ…ë°© ${this.rooms.length}ê°œ ë¡œë“œë¨`);
            } catch (error) {
                log(`${this.id}: ì±„íŒ…ë°© ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨ - ${error}`);
                alert('ì±„íŒ…ë°© ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤');
            }
        }

        renderRoomList() {
            const container = document.getElementById(`roomList${this.id}`);
            container.innerHTML = '';

            if (this.rooms.length === 0) {
                container.innerHTML =
                    '<div style="padding: 16px; text-align: center; color: #999; font-size: 12px;">ì±„íŒ…ë°©ì´ ì—†ìŠµë‹ˆë‹¤</div>';
                return;
            }

            this.rooms.forEach(room => {
                const div = document.createElement('div');
                div.className = 'room-item';
                if (this.currentRoomId === room.roomId) {
                    div.classList.add('active');
                }

                const members = room.chatMembers || [];
                const memberNames = members.map(m => m.nickname).join(', ');

                div.innerHTML = `
                    <div class="room-item-title">${room.title || 'ì œëª© ì—†ìŒ'}</div>
                    <div class="room-item-info">ë©¤ë²„: ${memberNames}</div>
                `;

                div.onclick = () => this.selectRoom(room);
                container.appendChild(div);
            });
        }

        async selectRoom(room) {
            if (this.subscription) {
                this.subscription.unsubscribe();
                this.subscription = null;
            }

            this.currentRoom = room;
            this.currentRoomId = room.roomId;
            this.renderRoomList();

            document.getElementById(`roomName${this.id}`).textContent = room.title || 'ì œëª© ì—†ìŒ';
            document.getElementById(`messages${this.id}`).innerHTML = '';

            // ë‚ ì§œ ì¶”ì  ì´ˆê¸°í™”
            this.lastMessageDate = null;

            document.getElementById(`input${this.id}`).disabled = false;
            document.getElementById(`sendBtn${this.id}`).disabled = false;

            // ì±„íŒ… í˜ì´ì§€ë¥¼ ë¨¼ì € í‘œì‹œ
            this.showChatPage();

            // í˜ì´ì§€ê°€ í‘œì‹œëœ í›„ ì±„íŒ… ë‚´ì—­ ë¶ˆëŸ¬ì˜¤ê¸°
            await this.loadChatHistory(room.roomId);

            if (this.stompClient && this.stompClient.connected) {
                this.subscribeToRoom(room.roomId);
            }

            log(`${this.id}: ì±„íŒ…ë°© "${room.title}" ì„ íƒë¨ (ID: ${room.roomId})`);
        }

        showChatPage() {
            document.getElementById(`roomListPage${this.id}`).classList.add('hidden');
            document.getElementById(`chatPage${this.id}`).classList.add('active');
        }

        goBack() {
            document.getElementById(`roomListPage${this.id}`).classList.remove('hidden');
            document.getElementById(`chatPage${this.id}`).classList.remove('active');

            if (this.subscription) {
                this.subscription.unsubscribe();
                this.subscription = null;
            }

            log(`${this.id}: ì±„íŒ…ë°© ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°`);
        }

        async connectWebSocket() {
            return new Promise((resolve, reject) => {
                const socket = new SockJS(`${API_BASE}/ws/connect`);
                this.stompClient = Stomp.over(socket);
                this.stompClient.debug = (msg) => log(`${this.id} WS: ${msg}`);

                this.stompClient.connect(
                    { Authorization: `Bearer ${this.token}` },
                    (frame) => {
                        log(`${this.id}: WebSocket ì—°ê²°ë¨`);

                        if (this.currentRoomId) {
                            this.subscribeToRoom(this.currentRoomId);
                        }

                        resolve();
                    },
                    (error) => {
                        log(`${this.id}: WebSocket ì—°ê²° ì‹¤íŒ¨ - ${error}`);
                        reject(error);
                    }
                );
            });
        }

        async loadChatHistory(roomId, cursorMillis = null, size = 30) {
            if (!this.token) {
                log(`${this.id}: í† í°ì´ ì—†ì–´ ì±„íŒ… ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤`);
                return;
            }

            try {
                let url = `${API_BASE}/api/chat/rooms/${roomId}/messages?size=${size}`;
                if (cursorMillis) {
                    url += `&cursorMillis=${cursorMillis}`;
                }

                const res = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${this.token}` }
                });

                if (!res.ok) {
                    throw new Error('ì±„íŒ… ë‚´ì—­ ì¡°íšŒ ì‹¤íŒ¨');
                }

                const data = await res.json();
                log(`${this.id}: ì±„íŒ… ë‚´ì—­ ${data.messages.length}ê°œ ë¡œë“œë¨ (hasNext: ${data.hasNext})`);

                // APIëŠ” ìµœì‹ ìˆœ(DESC)ìœ¼ë¡œ ë‚´ë ¤ì£¼ë¯€ë¡œ ì—­ìˆœìœ¼ë¡œ ì •ë ¬í•˜ì—¬ ì˜¤ë˜ëœ ë©”ì‹œì§€ë¶€í„° í‘œì‹œ
                const messages = data.messages.reverse();

                messages.forEach(msg => {
                    this.displayHistoryMessage(msg);
                });

                // DOM ë Œë”ë§ ì™„ë£Œ í›„ ìŠ¤í¬ë¡¤ì„ ìµœí•˜ë‹¨ìœ¼ë¡œ ì´ë™
                requestAnimationFrame(() => {
                    const container = document.getElementById(`messages${this.id}`);
                    container.scrollTop = container.scrollHeight;
                    log(`${this.id}: ìŠ¤í¬ë¡¤ì„ ìµœí•˜ë‹¨ìœ¼ë¡œ ì´ë™ (scrollTop: ${container.scrollTop}, scrollHeight: ${container.scrollHeight})`);
                });

                // ë” ë§ì€ ë©”ì‹œì§€ê°€ ìˆìœ¼ë©´ ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ ê°€ëŠ¥
                if (data.hasNext) {
                    log(`${this.id}: ë” ë§ì€ ë©”ì‹œì§€ê°€ ìˆìŠµë‹ˆë‹¤ (nextCursor: ${data.nextCursorMillis})`);
                    // TODO: ìŠ¤í¬ë¡¤ ìƒë‹¨ ë„ë‹¬ ì‹œ ì´ì „ ë©”ì‹œì§€ ë¡œë“œ
                }

            } catch (error) {
                log(`${this.id}: ì±„íŒ… ë‚´ì—­ ë¡œë“œ ì‹¤íŒ¨ - ${error}`);
            }
        }

        displayHistoryMessage(data) {
            const container = document.getElementById(`messages${this.id}`);

            // ë‚ ì§œ êµ¬ë¶„ì„  ì¶”ê°€
            if (data.sentAt) {
                const messageDate = this.getDateString(data.sentAt);
                if (this.lastMessageDate !== messageDate) {
                    this.addDateSeparator(container, messageDate);
                    this.lastMessageDate = messageDate;
                }
            }

            // ë©”ì‹œì§€ í‘œì‹œ
            const div = document.createElement('div');

            // ë‚´ ë©”ì‹œì§€ì¸ì§€ í™•ì¸
            const isMine = data.senderId === this.myUserId;
            log(`${this.id}: displayHistory - senderId: ${data.senderId}, myUserId: ${this.myUserId}, isMine: ${isMine}`);

            div.className = isMine ? 'message mine' : 'message';

            // ì±„íŒ…ë°© ë©¤ë²„ ì •ë³´ì—ì„œ í”„ë¡œí•„ ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ê¸°
            let avatarContent = '';
            let senderProfileImage = null;

            if (this.currentRoom && this.currentRoom.chatMembers) {
                const member = this.currentRoom.chatMembers.find(m => m.userId === data.senderId);
                if (member) {
                    senderProfileImage = member.profileImageUrl;
                }
            }

            if (senderProfileImage) {
                avatarContent = `<img src="${senderProfileImage}" alt="${data.senderName || 'User'}" />`;
            } else {
                const initial = (data.senderName || data.senderId || 'U').toString().charAt(0).toUpperCase();
                avatarContent = initial;
            }

            const time = data.sentAt ? new Date(data.sentAt).toLocaleTimeString('ko-KR', {
                hour: '2-digit',
                minute: '2-digit'
            }) : '';

            div.innerHTML = `
                <div class="message-avatar">${avatarContent}</div>
                <div class="message-content">
                    <div class="message-sender">${data.senderName || (data.senderId ? `User ${data.senderId}` : '')}</div>
                    <div class="message-bubble">${this.escapeHtml(data.content || '')}</div>
                    <div class="message-time">${time}</div>
                </div>
            `;

            container.appendChild(div);
        }

        subscribeToRoom(roomId) {
            if (!this.stompClient || !this.stompClient.connected) {
                log(`${this.id}: WebSocketì´ ì—°ê²°ë˜ì§€ ì•ŠìŒ`);
                return;
            }

            this.subscription = this.stompClient.subscribe(
                `/sub/chat/rooms/${roomId}`,
                (message) => {
                    log(`${this.id}: RECV raw: ${message.body}`);

                    let data;
                    try {
                        data = JSON.parse(message.body);
                    } catch (e) {
                        data = { content: message.body };
                    }

                    this.displayMessage(data);
                }
            );

            log(`${this.id}: ì±„íŒ…ë°© ${roomId} êµ¬ë… ì‹œì‘`);
        }

        // isLocal: ë‚´ê°€ ì§€ê¸ˆ ë³´ë‚¸ ë©”ì‹œì§€(ë¡œì»¬ ì—ì½”)ì¸ì§€ ì—¬ë¶€
    displayMessage(data) {
        const container = document.getElementById(`messages${this.id}`);

        // ë‚ ì§œ êµ¬ë¶„ì„  ì¶”ê°€
        if (data.sentAt) {
            const messageDate = this.getDateString(data.sentAt);
            if (this.lastMessageDate !== messageDate) {
                this.addDateSeparator(container, messageDate);
                this.lastMessageDate = messageDate;
            }
        }

        const div = document.createElement('div');
        const isMine = data.senderId && this.myUserId && data.senderId === this.myUserId;
        log(`${this.id}: displayMessage - senderId: ${data.senderId}, myUserId: ${this.myUserId}, isMine: ${isMine}`);
        div.className = isMine ? 'message mine' : 'message';

        // ì±„íŒ…ë°© ë©¤ë²„ ì •ë³´ì—ì„œ í”„ë¡œí•„ ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ê¸°
        let avatarContent = '';
        let senderProfileImage = null;

        if (this.currentRoom && this.currentRoom.chatMembers) {
            const member = this.currentRoom.chatMembers.find(m => m.userId === data.senderId);
            if (member) {
                senderProfileImage = member.profileImageUrl;
            }
        }

        if (senderProfileImage) {
            avatarContent = `<img src="${senderProfileImage}" alt="${data.senderName || 'User'}" />`;
        } else {
            const initial = (data.senderName || data.senderId || 'U').toString().charAt(0).toUpperCase();
            avatarContent = initial;
        }

        const time = data.sentAt ? new Date(data.sentAt).toLocaleTimeString('ko-KR', {
            hour: '2-digit',
            minute: '2-digit'
        }) : '';

        div.innerHTML = `
            <div class="message-avatar">${avatarContent}</div>
            <div class="message-content">
                <div class="message-sender">${data.senderName || (data.senderId ? `User ${data.senderId}` : '')}</div>
                <div class="message-bubble">${this.escapeHtml(data.content || '')}</div>
                <div class="message-time">${time}</div>
            </div>
        `;

        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
    }

        sendMessage() {
            if (!this.stompClient || !this.stompClient.connected) {
                alert('WebSocketì´ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤');
                return;
            }

            if (!this.currentRoomId) {
                alert('ì±„íŒ…ë°©ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”');
                return;
            }

            const input = document.getElementById(`input${this.id}`);
            const content = input.value.trim();
            if (!content) return;

            const payload = {
                type: 'TALK',
                content: content
            };

            // 1) ì„œë²„ë¡œ ì „ì†¡
            this.stompClient.send(
                `/pub/chat/rooms/${this.currentRoomId}/send`,
                {},
                JSON.stringify(payload)
            );

            input.value = '';
            log(`${this.id}: ë©”ì‹œì§€ ì „ì†¡ - "${content}"`);
        }

        async createRoom() {
            if (!this.token) {
                alert('ë¨¼ì € ë¡œê·¸ì¸í•˜ì„¸ìš”');
                return;
            }

            const title = prompt('ì±„íŒ…ë°© ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”:');
            if (!title) return;

            const memberIdsStr = prompt('ì´ˆëŒ€í•  ë©¤ë²„ IDë¥¼ ì‰¼í‘œë¡œ êµ¬ë¶„í•˜ì—¬ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 1,2,3):');
            if (!memberIdsStr) return;

            const memberIds = memberIdsStr.split(',')
                .map(id => parseInt(id.trim()))
                .filter(id => !isNaN(id));

            try {
                const res = await fetch(`${API_BASE}/api/chat/rooms`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${this.token}`
                    },
                    body: JSON.stringify({
                        title: title,
                        memberIds: memberIds,
                        type: 'GROUP',
                        postId: null
                    })
                });

                if (!res.ok) {
                    const error = await res.text();
                    throw new Error(error);
                }

                const newRoom = await res.json();
                log(`${this.id}: ì±„íŒ…ë°© ìƒì„±ë¨ - ${newRoom.title} (ID: ${newRoom.roomId})`);

                await this.loadRooms();
                alert('ì±„íŒ…ë°©ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!');
            } catch (error) {
                log(`${this.id}: ì±„íŒ…ë°© ìƒì„± ì‹¤íŒ¨ - ${error}`);
                alert('ì±„íŒ…ë°© ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        getSenderIdFromToken() {
            if (!this.token) return null;
            try {
                const base64Url = this.token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(c => {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                const payload = JSON.parse(jsonPayload);
                return payload.userId || payload.sub || payload.id;
            } catch (e) {
                return null;
            }
        }

        getDateString(dateString) {
            const date = new Date(dateString);
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);

            // ë‚ ì§œë¥¼ YYYY-MM-DD í˜•ì‹ìœ¼ë¡œ ë¹„êµ
            const dateStr = date.toISOString().split('T')[0];
            const todayStr = today.toISOString().split('T')[0];
            const yesterdayStr = yesterday.toISOString().split('T')[0];

            if (dateStr === todayStr) {
                return 'ì˜¤ëŠ˜';
            } else if (dateStr === yesterdayStr) {
                return 'ì–´ì œ';
            } else {
                // YYYYë…„ MMì›” DDì¼ í˜•ì‹
                const year = date.getFullYear();
                const month = date.getMonth() + 1;
                const day = date.getDate();
                return `${year}ë…„ ${month}ì›” ${day}ì¼`;
            }
        }

        addDateSeparator(container, dateText) {
            const separator = document.createElement('div');
            separator.className = 'date-separator';
            separator.innerHTML = `<div class="date-separator-text">${dateText}</div>`;
            container.appendChild(separator);
        }

        escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }
    }

    // í´ë¼ì´ì–¸íŠ¸ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
    const clientA = new ChatClient('A', 'A'); // ì™¼ìª½ í™”ë©´
    const clientB = new ChatClient('B', 'B'); // ì˜¤ë¥¸ìª½ í™”ë©´

    async function loginBothClients() {
        const token = document.getElementById('sharedToken').value.trim();

        if (!token) {
            alert('ì¹´ì¹´ì˜¤ ì•¡ì„¸ìŠ¤ í† í°ì„ ì…ë ¥í•˜ì„¸ìš”');
            return;
        }

        log('ì–‘ìª½ í´ë¼ì´ì–¸íŠ¸ ë¡œê·¸ì¸ ì‹œì‘');

        try {
            await Promise.all([
                clientA.login(token),
                clientB.login(token)
            ]);
            log('âœ… ì–‘ìª½ í´ë¼ì´ì–¸íŠ¸ ë¡œê·¸ì¸ ì™„ë£Œ');
        } catch (error) {
            log('âŒ ë¡œê·¸ì¸ ì‹¤íŒ¨: ' + error.message);
            alert('ë¡œê·¸ì¸ ì‹¤íŒ¨: ' + error.message);
        }
    }

    document.getElementById('inputA').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') clientA.sendMessage();
    });
    document.getElementById('inputB').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') clientB.sendMessage();
    });

    document.getElementById('sharedToken').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') loginBothClients();
    });

    window.addEventListener('load', async () => {
        log('ì±„íŒ… í…ŒìŠ¤íŠ¸ í˜ì´ì§€ ë¡œë“œë¨');
        log('ìë™ ë¡œê·¸ì¸ ì‹œë„ ì¤‘...');

        await clientA.autoLogin();
        await clientB.autoLogin();
    });
</script>

</body>
</html>
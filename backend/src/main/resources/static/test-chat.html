<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>STOMP Chat Test - 2 Clients + Auth</title>
    <style>
        body {
            font-family: sans-serif;
        }
        .top-panel {
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 12px;
        }
        .container {
            display: flex;
            gap: 20px;
        }
        .client {
            flex: 1;
            border: 1px solid #ccc;
            padding: 10px;
        }
        .client h2 {
            margin-top: 0;
        }
        pre {
            background: #111;
            color: #0f0;
            padding: 8px;
            height: 250px;
            overflow: auto;
            font-size: 12px;
        }
        input {
            margin: 2px 0;
            width: 100%;
            box-sizing: border-box;
        }
        button {
            margin-top: 4px;
        }
        .btn-block {
            width: 100%;
        }
        .actions-row {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: flex-end;
        }
        .actions-row > div {
            min-width: 220px;
        }
        label {
            font-size: 13px;
        }
    </style>
</head>
<body>
<h1>2-Client Chat Test (JWT + Room ìƒì„±)</h1>

<!-- 1,2,3 í†µí•© ì œì–´ íŒ¨ë„ -->
<div class="top-panel">
    <h2>ìƒë‹¨ ì œì–´ íŒ¨ë„ (1,2,3 í†µí•©)</h2>

    <div class="actions-row">
        <!-- 1) íšŒì›ê°€ì… ì™„ë£Œ & í† í° ì €ì¥ -->
        <div>
            <label>
                1) loginToken:
                <input id="loginTokenInput" placeholder="loginToken ì…ë ¥" />
            </label>
            <button onclick="completeSignup()">íšŒì›ê°€ì… ì™„ë£Œ (í† í° ë°œê¸‰)</button>
            <button onclick="showStoredToken()">ì €ì¥ëœ accessToken í™•ì¸</button>
        </div>

        <!-- 2) ë°© ë§Œë“¤ê¸° & STOMP ì—°ê²° -->
        <div>
            <label style="display:block;">2) ë°© ë§Œë“¤ê¸° (JWT í•„ìš”)</label>
            <button onclick="createRoomAndConnect()">ë°© ë§Œë“¤ê¸° & A/B ì—°ê²°</button>
        </div>

        <!-- 3) ê¸°ì¡´ ë°© ì—°ê²°ë§Œ í•˜ê¸° -->
        <div>
            <label>
                3) ê¸°ì¡´ roomId:
                <input id="existingRoomIdInput" placeholder="ì´ë¯¸ ì¡´ì¬í•˜ëŠ” roomId ì…ë ¥" />
            </label>
            <button onclick="connectExistingRoom()">ê¸°ì¡´ ë°©ì— ì—°ê²° (A/B ë‘˜ ë‹¤)</button>
        </div>
    </div>

    <pre id="topLog"></pre>
</div>

<div class="container">
    <!-- Client A -->
    <div class="client">
        <h2>Client A</h2>
        <label>
            Room ID:
            <input id="roomIdA" value="1" />
        </label>
        <br />
        <label>
            ë©”ì‹œì§€:
            <input id="msgA" placeholder="ë©”ì‹œì§€ ì…ë ¥" />
        </label>
        <br />
        <button class="btn-block" onclick="sendMessageA()">A â†’ ì „ì†¡</button>
        <pre id="logA"></pre>
    </div>

    <!-- Client B -->
    <div class="client">
        <h2>Client B</h2>
        <label>
            Room ID:
            <input id="roomIdB" value="1" />
        </label>
        <br />
        <label>
            ë©”ì‹œì§€:
            <input id="msgB" placeholder="ë©”ì‹œì§€ ì…ë ¥" />
        </label>
        <br />
        <button class="btn-block" onclick="sendMessageB()">B â†’ ì „ì†¡</button>
        <pre id="logB"></pre>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
<script>
    // ===== ê³µí†µ ë¡œê·¸ í•¨ìˆ˜ =====
    function topLog(msg) {
        const area = document.getElementById("topLog");
        if (area) area.textContent += msg + "\n";
    }
    function logA(msg) {
        document.getElementById('logA').textContent += msg + "\n";
    }
    function logB(msg) {
        document.getElementById('logB').textContent += msg + "\n";
    }

    // ===== 1) /auth/complete-signup í˜¸ì¶œí•´ì„œ accessToken ì €ì¥ =====
    async function completeSignup() {
        const loginToken = document.getElementById("loginTokenInput").value.trim();
        if (!loginToken) {
            topLog("âš  loginTokenì„ ë¨¼ì € ì…ë ¥í•˜ì„¸ìš”.");
            return;
        }

        try {
            const res = await fetch("http://localhost:8080/auth/complete-signup", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    loginToken: loginToken,
                    serviceTermsAgreed: true,
                    privacyPolicyAgreed: true,
                    marketingOptionalAgreed: true
                }),
                credentials: "include"
            });

            const body = await res.json();
            console.log("complete-signup response:", body);
            topLog("ì‘ë‹µ: " + JSON.stringify(body));

            if (!res.ok) {
                topLog("âŒ complete-signup ì‹¤íŒ¨: " + res.status);
                return;
            }

            const accessToken =
                body.accessToken ||
                body.token ||
                body.jwt ||
                body.loginToken;

            if (!accessToken) {
                topLog("âš  ì‘ë‹µ ë°”ë””ì—ì„œ í† í°ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì‹¤ì œ JSON êµ¬ì¡°ë¥¼ í™•ì¸í•´ì„œ í•„ë“œëª…ì„ ìˆ˜ì •í•˜ì„¸ìš”.");
                return;
            }

            localStorage.setItem("accessToken", accessToken);
            topLog("âœ… accessToken ì €ì¥ ì™„ë£Œ: " + accessToken.substring(0, 25) + "...");
        } catch (e) {
            console.error(e);
            topLog("âŒ complete-signup í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜: " + e);
        }
    }

    function showStoredToken() {
        const t = localStorage.getItem("accessToken");
        if (!t) {
            topLog("â„¹ ì €ì¥ëœ accessToken ì´ ì—†ìŠµë‹ˆë‹¤.");
        } else {
            topLog("ğŸ“¦ ì €ì¥ëœ accessToken: " + t);
        }
    }

    // ===== STOMP í´ë¼ì´ì–¸íŠ¸ =====
    let stompClientA = null;
    let stompClientB = null;

    function disconnectClients() {
        if (stompClientA && stompClientA.connected) {
            stompClientA.disconnect(() => logA("DISCONNECTED"));
        }
        if (stompClientB && stompClientB.connected) {
            stompClientB.disconnect(() => logB("DISCONNECTED"));
        }
        stompClientA = null;
        stompClientB = null;
    }

    // ===== 2) ë°© ìƒì„± + STOMP ì—°ê²° =====
    async function createRoomAndConnect() {
        const token = localStorage.getItem("accessToken");
        if (!token) {
            topLog("âš  accessToken ì—†ìŒ. ë¨¼ì € ìœ„ì—ì„œ complete-signup ë²„íŠ¼ìœ¼ë¡œ í† í°ì„ ë°œê¸‰ë°›ìœ¼ì„¸ìš”.");
            return;
        }

        try {
            const requestBody = {
                title: "í…ŒìŠ¤íŠ¸ ì±„íŒ…ë°©",
                memberIds: [1, 2],
                type: "PRIVATE",
                postId: 1
            };

            topLog("ë°© ìƒì„± ìš”ì²­ ë°”ë””: " + JSON.stringify(requestBody));

            const res = await fetch("http://localhost:8080/api/chat/rooms", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": "Bearer " + token
                },
                body: JSON.stringify(requestBody),
                credentials: "include"
            });

            const raw = await res.text();
            topLog(`RAW ì‘ë‹µ (status=${res.status}): ${raw}`);

            let data = {};
            try {
                data = raw ? JSON.parse(raw) : {};
            } catch (parseErr) {
                topLog("âŒ JSON íŒŒì‹± ì‹¤íŒ¨: " + parseErr);
                console.error("JSON parse error:", parseErr);
                return;
            }

            console.log("create room response:", data);
            topLog("íŒŒì‹±ëœ JSON: " + JSON.stringify(data));

            if (!res.ok) {
                topLog("âŒ ë°© ìƒì„± ì‹¤íŒ¨: " + res.status);
                return;
            }

            const roomId = data.roomId ?? data.id;
            if (!roomId) {
                topLog("âš  ì‘ë‹µì—ì„œ roomId ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì‹¤ì œ JSON êµ¬ì¡° í™•ì¸ í•„ìš”.");
                return;
            }

            document.getElementById("roomIdA").value = roomId;
            document.getElementById("roomIdB").value = roomId;
            topLog("âœ… ë°© ìƒì„± ì„±ê³µ, roomId = " + roomId);

            disconnectClients();
            connectClientA(roomId, token);
            connectClientB(roomId, token);
        } catch (e) {
            console.error(e);
            topLog("âŒ ë°© ìƒì„± ì¤‘ ì˜¤ë¥˜: " + e);
        }
    }

    // ===== 3) ê¸°ì¡´ ë°©ì— ì—°ê²°ë§Œ í•˜ê¸° =====
    function connectExistingRoom() {
        const token = localStorage.getItem("accessToken");
        if (!token) {
            topLog("âš  accessToken ì—†ìŒ. ë¨¼ì € complete-signupìœ¼ë¡œ í† í°ì„ ë°œê¸‰ë°›ìœ¼ì„¸ìš”.");
            return;
        }

        const roomId = document.getElementById("existingRoomIdInput").value.trim();
        if (!roomId) {
            topLog("âš  roomId ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
            return;
        }

        document.getElementById("roomIdA").value = roomId;
        document.getElementById("roomIdB").value = roomId;

        topLog("â„¹ ê¸°ì¡´ roomId = " + roomId + " ë¡œ ì—°ê²° ì‹œë„ ì¤‘...");

        disconnectClients();
        connectClientA(roomId, token);
        connectClientB(roomId, token);
    }

    // ===== STOMP ì—°ê²° =====
    function connectClientA(roomId, token) {
        const socket = new SockJS('http://localhost:8080/ws/connect');
        stompClientA = Stomp.over(socket);
        stompClientA.debug = null;

        const connectHeaders = {
            Authorization: "Bearer " + token
        };

        stompClientA.connect(connectHeaders, (frame) => {
            logA('CONNECTED: ' + frame);
            stompClientA.subscribe('/sub/rooms/' + roomId, (message) => {
                logA('RECV: ' + message.body);
            });
        }, (error) => {
            logA('ERROR: ' + error);
        });
    }

    function connectClientB(roomId, token) {
        const socket = new SockJS('http://localhost:8080/ws/connect');
        stompClientB = Stomp.over(socket);
        stompClientB.debug = null;

        const connectHeaders = {
            Authorization: "Bearer " + token
        };

        stompClientB.connect(connectHeaders, (frame) => {
            logB('CONNECTED: ' + frame);
            stompClientB.subscribe('/sub/rooms/' + roomId, (message) => {
                logB('RECV: ' + message.body);
            });
        }, (error) => {
            logB('ERROR: ' + error);
        });
    }

    // ===== ë©”ì‹œì§€ ì „ì†¡ =====
    function sendMessageA() {
        if (!stompClientA || !stompClientA.connected) {
            logA('WARN: ì•„ì§ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë¨¼ì € ë°© ë§Œë“¤ê¸° ë˜ëŠ” ê¸°ì¡´ ë°© ì—°ê²°ì„ í•˜ì„¸ìš”.');
            return;
        }
        const roomId = document.getElementById('roomIdA').value;
        const msg = document.getElementById('msgA').value;

        const payload = {
            content: msg
        };

        stompClientA.send('/pub/rooms/' + roomId + '/send', {}, JSON.stringify(payload));
        logA('SEND: ' + JSON.stringify(payload));
    }

    function sendMessageB() {
        if (!stompClientB || !stompClientB.connected) {
            logB('WARN: ì•„ì§ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë¨¼ì € ë°© ë§Œë“¤ê¸° ë˜ëŠ” ê¸°ì¡´ ë°© ì—°ê²°ì„ í•˜ì„¸ìš”.');
            return;
        }
        const roomId = document.getElementById('roomIdB').value;
        const msg = document.getElementById('msgB').value;

        const payload = {
            content: msg
        };

        stompClientB.send('/pub/rooms/' + roomId + '/send', {}, JSON.stringify(payload));
        logB('SEND: ' + JSON.stringify(payload));
    }
</script>
</body>
</html>
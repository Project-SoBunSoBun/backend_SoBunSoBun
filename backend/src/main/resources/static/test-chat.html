<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>ì±„íŒ… í…ŒìŠ¤íŠ¸ - 2 í´ë¼ì´ì–¸íŠ¸</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            overflow: hidden; /* í˜ì´ì§€ ìì²´ ìŠ¤í¬ë¡¤ ì œê±° */
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #f0f0f0;
            display: flex;
            flex-direction: column;
        }

        /* ë©”ì¸ ì˜ì—­: ì¢Œìš° 2 í´ë¼ì´ì–¸íŠ¸ */
        .container {
            flex: 1 1 auto;
            display: flex;
            gap: 2px;
            height: 100%;
            overflow: hidden; /* ë‚´ë¶€ì—ì„œë§Œ ìŠ¤í¬ë¡¤ ë‚˜ë„ë¡ */
        }

        .client-wrapper {
            flex: 1;
            display: flex;
            background: white;
            position: relative;
        }

        /* ì±„íŒ…ë°© ëª©ë¡ í˜ì´ì§€ */
        .room-list-page {
            position: absolute;
            inset: 0;
            background: white;
            display: flex;
            flex-direction: column;
        }
        .room-list-page.hidden {
            display: none; /* ë°©ì— ë“¤ì–´ê°€ë©´ ëª©ë¡ì€ ì•ˆ ë³´ì´ê²Œ */
        }

        /* ì±„íŒ…ë°© í˜ì´ì§€ */
        .chat-page {
            position: absolute;
            inset: 0;
            background: white;
            display: none;
            flex-direction: column;
        }
        .chat-page.active {
            display: flex;
        }

        .page-header {
            padding: 10px 12px;
            background: #3b5998;
            color: white;
            font-weight: bold;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 0 0 auto;
        }

        .back-button {
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            padding: 0;
            width: 26px;
            height: 26px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .back-button:hover {
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
        }

        .page-title {
            flex: 1;
        }

        .status {
            padding: 5px 8px;
            font-size: 11px;
            text-align: center;
            background: #fff3cd;
            border-bottom: 1px solid #ffc107;
            flex: 0 0 auto;
        }
        .status.connected {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }
        .status.error {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }

        .room-list-controls {
            padding: 8px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
            flex: 0 0 auto;
        }
        .room-list-controls button {
            width: 100%;
            padding: 6px;
            background: #3b5998;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-bottom: 4px;
        }
        .room-list-controls button:hover {
            background: #2d4373;
        }

        .room-items {
            flex: 1 1 auto;
            overflow-y: auto;
        }

        .room-item {
            padding: 10px 12px;
            border-bottom: 1px solid #e0e0e0;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 13px;
        }
        .room-item:hover {
            background: #f5f5f5;
        }
        .room-item.active {
            background: #e3f2fd;
        }
        .room-item-title {
            font-weight: 600;
            margin-bottom: 4px;
            font-size: 13px;
        }
        .room-item-info {
            font-size: 11px;
            color: #666;
        }

        /* ì±„íŒ… ë©”ì‹œì§€ ì˜ì—­ */
        .messages {
            flex: 1 1 auto;
            overflow-y: auto;
            padding: 12px;
            background: #ffffff;
        }
        .message {
            margin-bottom: 10px;
            display: flex;
            align-items: flex-start;
        }
        .message.mine {
            flex-direction: row-reverse; /* ë‚´ ë©”ì‹œì§€ëŠ” ì˜¤ë¥¸ìª½ */
        }
        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 14px;
            flex-shrink: 0;
            overflow: hidden;
        }
        .message-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .message-content {
            max-width: 70%;
            margin: 0 8px;
        }
        .message.mine .message-content {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }
        .message-sender {
            font-size: 11px;
            color: #666;
            margin-bottom: 3px;
        }
        .message.mine .message-sender {
            display: none;
        }
        .message-bubble {
            padding: 8px 11px;
            border-radius: 16px;
            background: #f0f0f0;
            display: inline-block;
            word-wrap: break-word;
            font-size: 13px;
        }
        .message.mine .message-bubble {
            background: #3b5998;
            color: white;
        }
        .message-time {
            font-size: 10px;
            color: #999;
            margin-top: 3px;
        }

        /* ë‚ ì§œ êµ¬ë¶„ì„  */
        .date-separator {
            display: flex;
            align-items: center;
            margin: 20px 0;
            text-align: center;
        }
        .date-separator::before,
        .date-separator::after {
            content: '';
            flex: 1;
            border-bottom: 1px solid #e0e0e0;
        }
        .date-separator-text {
            padding: 0 16px;
            font-size: 12px;
            color: #666;
            background: #f5f5f5;
            border-radius: 12px;
            padding: 4px 12px;
        }

        /* ì…ë ¥ ì˜ì—­ */
        .input-area {
            padding: 8px 10px;
            border-top: 1px solid #e0e0e0;
            background: white;
            display: flex;
            gap: 8px;
            flex: 0 0 auto;
        }
        .input-area input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 20px;
            font-size: 13px;
        }
        .input-area button {
            padding: 8px 16px;
            background: #3b5998;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            font-size: 13px;
        }
        .input-area button:hover {
            background: #2d4373;
        }
        .input-area button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* ë¡œê·¸ íŒ¨ë„ */
        .log-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 140px;
            background: #1e1e1e;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            padding: 8px;
            overflow-y: auto;
            display: none;
            z-index: 900;
        }
        .log-panel.show {
            display: block;
        }
        .toggle-log {
            position: fixed;
            bottom: 8px;
            right: 8px;
            padding: 6px 12px;
            background: #333;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            z-index: 1000;
            font-size: 11px;
        }

        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal-container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            padding: 32px;
        }

        .modal-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .modal-header h2 {
            font-size: 24px;
            color: #333;
            margin-bottom: 8px;
        }

        .modal-header p {
            font-size: 13px;
            color: #666;
        }

        .modal-form-group {
            margin-bottom: 20px;
        }

        .modal-form-group label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: #333;
            margin-bottom: 6px;
        }

        .modal-form-group label .optional {
            font-weight: 400;
            color: #999;
            font-size: 11px;
        }

        .modal-form-group input[type="text"],
        .modal-form-group input[type="number"],
        .modal-form-group select {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 13px;
            transition: border-color 0.2s;
        }

        .modal-form-group input:focus,
        .modal-form-group select:focus {
            outline: none;
            border-color: #3b5998;
        }

        .modal-form-group .help-text {
            font-size: 11px;
            color: #666;
            margin-top: 4px;
        }

        .image-upload-container {
            border: 2px dashed #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            transition: all 0.2s;
            cursor: pointer;
        }

        .image-upload-container:hover {
            border-color: #3b5998;
            background: #f8f9ff;
        }

        .image-upload-container.has-image {
            border-color: #3b5998;
            background: #f8f9ff;
        }

        .image-upload-container input[type="file"] {
            display: none;
        }

        .upload-icon {
            font-size: 40px;
            color: #ccc;
            margin-bottom: 6px;
        }

        .upload-text {
            font-size: 13px;
            color: #666;
        }

        .image-preview-container {
            display: none;
            margin-top: 12px;
        }

        .image-preview-container.show {
            display: block;
        }

        .image-preview-container img {
            max-width: 100%;
            max-height: 150px;
            border-radius: 6px;
        }

        .image-preview-container .remove-image {
            margin-top: 6px;
            padding: 4px 10px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
        }

        .image-preview-container .remove-image:hover {
            background: #d32f2f;
        }

        .member-ids-container {
            margin-top: 8px;
        }

        .member-id-tag {
            display: inline-flex;
            align-items: center;
            background: #e3f2fd;
            color: #1976d2;
            padding: 4px 8px;
            border-radius: 4px;
            margin-right: 6px;
            margin-bottom: 6px;
            font-size: 11px;
        }

        .member-id-tag .remove-tag {
            margin-left: 6px;
            cursor: pointer;
            font-weight: bold;
        }

        .modal-btn-container {
            display: flex;
            gap: 10px;
            margin-top: 24px;
        }

        .modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .modal-btn-primary {
            background: #3b5998;
            color: white;
        }

        .modal-btn-primary:hover {
            background: #2d4373;
        }

        .modal-btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .modal-btn-secondary {
            background: #f5f5f5;
            color: #666;
        }

        .modal-btn-secondary:hover {
            background: #e0e0e0;
        }

        .modal-status {
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 16px;
            font-size: 12px;
            display: none;
        }

        .modal-status.show {
            display: block;
        }

        .modal-status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .modal-status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .modal-status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body>

<div class="container">
    <!-- Client A -->
    <div class="client-wrapper">
        <!-- ì±„íŒ…ë°© ëª©ë¡ í˜ì´ì§€ -->
        <div class="room-list-page" id="roomListPageA">
            <div class="page-header">
                <div class="page-title">í´ë¼ì´ì–¸íŠ¸ A - ì±„íŒ…ë°© ëª©ë¡</div>
            </div>
            <div class="status" id="statusA">í† í°ì„ ì…ë ¥í•˜ê³  ë¡œê·¸ì¸í•˜ì„¸ìš”</div>
            <div class="room-list-controls">
                <input id="tokenA" type="text" placeholder="ì¹´ì¹´ì˜¤ ì•¡ì„¸ìŠ¤ í† í°" style="width: 100%; margin-bottom: 4px; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;" />
                <button onclick="clientA.loginWithToken()">ë¡œê·¸ì¸</button>
                <button onclick="clientA.createRoom()">ìƒˆ ì±„íŒ…ë°© ë§Œë“¤ê¸°</button>
            </div>
            <div class="room-items" id="roomListA"></div>
        </div>

        <!-- ì±„íŒ…ë°© í˜ì´ì§€ -->
        <div class="chat-page" id="chatPageA">
            <div class="page-header">
                <button class="back-button" onclick="clientA.goBack()">â†</button>
                <div class="page-title" id="roomNameA">ì±„íŒ…ë°©</div>
            </div>
            <div class="messages" id="messagesA"></div>
            <div class="input-area">
                <input id="inputA" type="text" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”" disabled />
                <button id="sendBtnA" onclick="clientA.sendMessage()" disabled>ì „ì†¡</button>
            </div>
        </div>
    </div>

    <!-- Client B -->
    <div class="client-wrapper">
        <!-- ì±„íŒ…ë°© ëª©ë¡ í˜ì´ì§€ -->
        <div class="room-list-page" id="roomListPageB">
            <div class="page-header">
                <div class="page-title">í´ë¼ì´ì–¸íŠ¸ B - ì±„íŒ…ë°© ëª©ë¡</div>
            </div>
            <div class="status" id="statusB">í† í°ì„ ì…ë ¥í•˜ê³  ë¡œê·¸ì¸í•˜ì„¸ìš”</div>
            <div class="room-list-controls">
                <input id="tokenB" type="text" placeholder="ì¹´ì¹´ì˜¤ ì•¡ì„¸ìŠ¤ í† í°" style="width: 100%; margin-bottom: 4px; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;" />
                <button onclick="clientB.loginWithToken()">ë¡œê·¸ì¸</button>
                <button onclick="clientB.createRoom()">ìƒˆ ì±„íŒ…ë°© ë§Œë“¤ê¸°</button>
            </div>
            <div class="room-items" id="roomListB"></div>
        </div>

        <!-- ì±„íŒ…ë°© í˜ì´ì§€ -->
        <div class="chat-page" id="chatPageB">
            <div class="page-header">
                <button class="back-button" onclick="clientB.goBack()">â†</button>
                <div class="page-title" id="roomNameB">ì±„íŒ…ë°©</div>
            </div>
            <div class="messages" id="messagesB"></div>
            <div class="input-area">
                <input id="inputB" type="text" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”" disabled />
                <button id="sendBtnB" onclick="clientB.sendMessage()" disabled>ì „ì†¡</button>
            </div>
        </div>
    </div>
</div>

<button class="toggle-log" onclick="toggleLog()">ë¡œê·¸ í‘œì‹œ/ìˆ¨ê¹€</button>
<div class="log-panel" id="logPanel"></div>

<!-- ì±„íŒ…ë°© ìƒì„± ëª¨ë‹¬ -->
<div class="modal-overlay" id="createRoomModal">
    <div class="modal-container">
        <div class="modal-header">
            <h2>ìƒˆ ì±„íŒ…ë°© ë§Œë“¤ê¸°</h2>
            <p>ì±„íŒ…ë°© ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”</p>
        </div>

        <div id="modalStatus" class="modal-status"></div>

        <form id="createRoomForm">
            <!-- ì±„íŒ…ë°© ì œëª© -->
            <div class="modal-form-group">
                <label>ì±„íŒ…ë°© ì œëª©</label>
                <input
                    type="text"
                    id="modalRoomTitle"
                    placeholder="ì±„íŒ…ë°© ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”"
                    required
                />
            </div>

            <!-- ì±„íŒ…ë°© íƒ€ì… -->
            <div class="modal-form-group">
                <label>ì±„íŒ…ë°© íƒ€ì…</label>
                <select id="modalRoomType" required>
                    <option value="GROUP">ê·¸ë£¹ ì±„íŒ…</option>
                    <option value="PRIVATE">1:1 ì±„íŒ…</option>
                </select>
            </div>

            <!-- ì´ˆëŒ€í•  ë©¤ë²„ -->
            <div class="modal-form-group">
                <label>ì´ˆëŒ€í•  ë©¤ë²„</label>
                <div style="display: flex; gap: 8px;">
                    <input
                        type="number"
                        id="modalMemberIdInput"
                        placeholder="ë©¤ë²„ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                        style="flex: 1;"
                    />
                    <button
                        type="button"
                        onclick="addModalMemberId()"
                        style="padding: 10px 16px; background: #3b5998; color: white; border: none; border-radius: 6px; cursor: pointer; white-space: nowrap; font-size: 13px;"
                    >
                        ì¶”ê°€
                    </button>
                </div>
                <div class="help-text">ë©¤ë²„ IDë¥¼ ì…ë ¥í•˜ê³  ì¶”ê°€ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”</div>
                <div id="modalMemberIdsContainer" class="member-ids-container"></div>
            </div>

            <!-- Post ID (ì„ íƒ) -->
            <div class="modal-form-group">
                <label>ê²Œì‹œê¸€ ID <span class="optional">(ì„ íƒì‚¬í•­)</span></label>
                <input
                    type="number"
                    id="modalPostId"
                    placeholder="ê²Œì‹œê¸€ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                />
                <div class="help-text">ê²Œì‹œê¸€ê³¼ ì—°ê²°ëœ ì±„íŒ…ë°©ì¸ ê²½ìš° ì…ë ¥í•˜ì„¸ìš”</div>
            </div>

            <!-- ì±„íŒ…ë°© ì´ë¯¸ì§€ -->
            <div class="modal-form-group">
                <label>ì±„íŒ…ë°© ì´ë¯¸ì§€ <span class="optional">(ì„ íƒì‚¬í•­)</span></label>
                <div class="image-upload-container" id="modalImageUploadContainer" onclick="document.getElementById('modalRoomImage').click()">
                    <input
                        type="file"
                        id="modalRoomImage"
                        accept="image/*"
                        onchange="handleModalImageSelect(event)"
                    />
                    <div class="upload-icon">ğŸ“·</div>
                    <div class="upload-text">í´ë¦­í•˜ì—¬ ì´ë¯¸ì§€ ì„ íƒ</div>
                    <div class="image-preview-container" id="modalImagePreview">
                        <img id="modalPreviewImage" src="" alt="ë¯¸ë¦¬ë³´ê¸°" />
                        <button type="button" class="remove-image" onclick="removeModalImage(event)">ì´ë¯¸ì§€ ì œê±°</button>
                    </div>
                </div>
            </div>

            <!-- ë²„íŠ¼ -->
            <div class="modal-btn-container">
                <button type="button" class="modal-btn modal-btn-secondary" onclick="closeCreateRoomModal()">ì·¨ì†Œ</button>
                <button type="submit" class="modal-btn modal-btn-primary" id="modalSubmitBtn">ì±„íŒ…ë°© ìƒì„±</button>
            </div>
        </form>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
<script>
    const API_BASE = 'http://localhost:8080';

    // ë¡œê·¸ í•¨ìˆ˜
    function log(msg) {
        const panel = document.getElementById('logPanel');
        const time = new Date().toLocaleTimeString();
        panel.textContent += `[${time}] ${msg}\n`;
        panel.scrollTop = panel.scrollHeight;
    }

    function toggleLog() {
        document.getElementById('logPanel').classList.toggle('show');
    }

    class ChatClient {
        constructor(id, uiClientId) {
            this.id = id;                    // A / B
            this.uiClientId = uiClientId;    // 'A' / 'B' (ì¢Œìš° ê´€ì )
            this.token = null;
            this.stompClient = null;
            this.currentRoom = null;
            this.currentRoomId = null;
            this.rooms = [];
            this.userInfo = null;
            this.subscription = null;
            this.storageKey = `chat_token_${id}`;
            this.lastMessageDate = null;     // ë§ˆì§€ë§‰ ë©”ì‹œì§€ ë‚ ì§œ ì¶”ì 
        }

        // localStorageì—ì„œ í† í° ë¡œë“œ
        loadTokenFromStorage() {
            const stored = localStorage.getItem(this.storageKey);
            if (stored) {
                this.token = stored;
                log(`${this.id}: localStorageì—ì„œ í† í° ë¡œë“œë¨`);
                return true;
            }
            return false;
        }

        saveTokenToStorage() {
            if (this.token) {
                localStorage.setItem(this.storageKey, this.token);
                log(`${this.id}: localStorageì— í† í° ì €ì¥ë¨`);
            }
        }

        clearTokenFromStorage() {
            localStorage.removeItem(this.storageKey);
            log(`${this.id}: localStorageì—ì„œ í† í° ì‚­ì œë¨`);
        }

        setStatus(message, type = 'normal') {
            const status = document.getElementById(`status${this.id}`);
            status.textContent = message;
            status.className = 'status';
            if (type === 'connected') status.classList.add('connected');
            if (type === 'error') status.classList.add('error');
        }

        async loginWithToken() {
            const tokenInput = document.getElementById(`token${this.id}`);
            const kakaoToken = tokenInput.value.trim();

            if (!kakaoToken) {
                alert('ì¹´ì¹´ì˜¤ ì•¡ì„¸ìŠ¤ í† í°ì„ ì…ë ¥í•˜ì„¸ìš”');
                return;
            }

            await this.login(kakaoToken);
        }

        async login(kakaoToken) {
            try {
                this.setStatus('ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘...');
                log(`${this.id}: ë¡œê·¸ì¸ ì‹œì‘`);

                const res = await fetch(`${API_BASE}/auth/complete-signup`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        loginToken: kakaoToken,
                        serviceTermsAgreed: true,
                        privacyPolicyAgreed: true,
                        marketingOptionalAgreed: false
                    })
                });

                if (!res.ok) {
                    const error = await res.text();
                    throw new Error(`ë¡œê·¸ì¸ ì‹¤íŒ¨: ${error}`);
                }

                const data = await res.json();
                this.token = data.accessToken;
                // Numberë¡œ íƒ€ì…ì„ ëª…í™•íˆ ì§€ì •
                this.myUserId = Number(data.user?.id ?? this.getSenderIdFromToken());
                log(`${this.id}: JWT ë°œê¸‰ ì™„ë£Œ - ì‚¬ìš©ì ID: ${this.myUserId} (íƒ€ì…: ${typeof this.myUserId})`);

                this.saveTokenToStorage();

                await this.loadRooms();
                await this.connectWebSocket();
                this.setStatus('ì—°ê²°ë¨', 'connected');
                log(`${this.id}: ë¡œê·¸ì¸ ì„±ê³µ`);

            } catch (error) {
                this.setStatus('ë¡œê·¸ì¸ ì‹¤íŒ¨', 'error');
                log(`${this.id}: ë¡œê·¸ì¸ ì‹¤íŒ¨ - ${error}`);
                throw error;
            }
        }

        async autoLogin() {
            if (this.loadTokenFromStorage()) {
                try {
                    // Numberë¡œ íƒ€ì…ì„ ëª…í™•íˆ ì§€ì •
                    this.myUserId = Number(this.getSenderIdFromToken());
                    this.setStatus('ìë™ ë¡œê·¸ì¸ ì¤‘...');
                    log(`${this.id}: ìë™ ë¡œê·¸ì¸ - ì‚¬ìš©ì ID: ${this.myUserId} (íƒ€ì…: ${typeof this.myUserId})`);
                    await this.loadRooms();
                    await this.connectWebSocket();
                    this.setStatus('ì—°ê²°ë¨ (ìë™)', 'connected');
                    log(`${this.id}: ìë™ ë¡œê·¸ì¸ ì„±ê³µ`);
                    return true;
                } catch (error) {
                    this.setStatus('í† í° ë§Œë£Œ - ë‹¤ì‹œ ë¡œê·¸ì¸í•˜ì„¸ìš”', 'error');
                    log(`${this.id}: ìë™ ë¡œê·¸ì¸ ì‹¤íŒ¨ - ${error}`);
                    this.clearTokenFromStorage();
                    return false;
                }
            }
            return false;
        }

        async loadRooms() {
            if (!this.token) {
                alert('ë¨¼ì € ë¡œê·¸ì¸í•˜ì„¸ìš”');
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/api/chat/rooms`, {
                    headers: { 'Authorization': `Bearer ${this.token}` }
                });

                if (!res.ok) throw new Error('ì±„íŒ…ë°© ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨');

                this.rooms = await res.json();
                this.renderRoomList();
                log(`${this.id}: ì±„íŒ…ë°© ${this.rooms.length}ê°œ ë¡œë“œë¨`);
            } catch (error) {
                log(`${this.id}: ì±„íŒ…ë°© ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨ - ${error}`);
                alert('ì±„íŒ…ë°© ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤');
            }
        }

        renderRoomList() {
            const container = document.getElementById(`roomList${this.id}`);
            container.innerHTML = '';

            if (this.rooms.length === 0) {
                container.innerHTML =
                    '<div style="padding: 16px; text-align: center; color: #999; font-size: 12px;">ì±„íŒ…ë°©ì´ ì—†ìŠµë‹ˆë‹¤</div>';
                return;
            }

            this.rooms.forEach(room => {
                const div = document.createElement('div');
                div.className = 'room-item';
                if (this.currentRoomId === room.roomId) {
                    div.classList.add('active');
                }

                const members = room.chatMembers || [];
                const memberNames = members.map(m => m.nickname).join(', ');

                div.innerHTML = `
                    <div class="room-item-title">${room.title || 'ì œëª© ì—†ìŒ'}</div>
                    <div class="room-item-info">ë©¤ë²„: ${memberNames}</div>
                `;

                div.onclick = () => this.selectRoom(room);
                container.appendChild(div);
            });
        }

        async selectRoom(room) {
            if (this.subscription) {
                this.subscription.unsubscribe();
                this.subscription = null;
            }

            this.currentRoom = room;
            this.currentRoomId = room.roomId;
            this.renderRoomList();

            document.getElementById(`roomName${this.id}`).textContent = room.title || 'ì œëª© ì—†ìŒ';
            document.getElementById(`messages${this.id}`).innerHTML = '';

            // ë‚ ì§œ ì¶”ì  ì´ˆê¸°í™”
            this.lastMessageDate = null;

            document.getElementById(`input${this.id}`).disabled = false;
            document.getElementById(`sendBtn${this.id}`).disabled = false;

            // ì±„íŒ… í˜ì´ì§€ë¥¼ ë¨¼ì € í‘œì‹œ
            this.showChatPage();

            // í˜ì´ì§€ê°€ í‘œì‹œëœ í›„ ì±„íŒ… ë‚´ì—­ ë¶ˆëŸ¬ì˜¤ê¸°
            await this.loadChatHistory(room.roomId);

            if (this.stompClient && this.stompClient.connected) {
                this.subscribeToRoom(room.roomId);
            }

            log(`${this.id}: ì±„íŒ…ë°© "${room.title}" ì„ íƒë¨ (ID: ${room.roomId})`);
        }

        showChatPage() {
            document.getElementById(`roomListPage${this.id}`).classList.add('hidden');
            document.getElementById(`chatPage${this.id}`).classList.add('active');
        }

        goBack() {
            document.getElementById(`roomListPage${this.id}`).classList.remove('hidden');
            document.getElementById(`chatPage${this.id}`).classList.remove('active');

            if (this.subscription) {
                this.subscription.unsubscribe();
                this.subscription = null;
            }

            log(`${this.id}: ì±„íŒ…ë°© ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°`);
        }

        async connectWebSocket() {
            return new Promise((resolve, reject) => {
                const socket = new SockJS(`${API_BASE}/ws/connect`);
                this.stompClient = Stomp.over(socket);
                this.stompClient.debug = (msg) => log(`${this.id} WS: ${msg}`);

                this.stompClient.connect(
                    { Authorization: `Bearer ${this.token}` },
                    (frame) => {
                        log(`${this.id}: WebSocket ì—°ê²°ë¨`);

                        if (this.currentRoomId) {
                            this.subscribeToRoom(this.currentRoomId);
                        }

                        resolve();
                    },
                    (error) => {
                        log(`${this.id}: WebSocket ì—°ê²° ì‹¤íŒ¨ - ${error}`);
                        reject(error);
                    }
                );
            });
        }

        async loadChatHistory(roomId, cursorMillis = null, size = 30) {
            if (!this.token) {
                log(`${this.id}: í† í°ì´ ì—†ì–´ ì±„íŒ… ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤`);
                return;
            }

            try {
                let url = `${API_BASE}/api/chat/rooms/${roomId}/messages?size=${size}`;
                if (cursorMillis) {
                    url += `&cursorMillis=${cursorMillis}`;
                }

                const res = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${this.token}` }
                });

                if (!res.ok) {
                    throw new Error('ì±„íŒ… ë‚´ì—­ ì¡°íšŒ ì‹¤íŒ¨');
                }

                const data = await res.json();
                log(`${this.id}: ì±„íŒ… ë‚´ì—­ ${data.messages.length}ê°œ ë¡œë“œë¨ (hasNext: ${data.hasNext})`);

                // APIëŠ” ìµœì‹ ìˆœ(DESC)ìœ¼ë¡œ ë‚´ë ¤ì£¼ë¯€ë¡œ ì—­ìˆœìœ¼ë¡œ ì •ë ¬í•˜ì—¬ ì˜¤ë˜ëœ ë©”ì‹œì§€ë¶€í„° í‘œì‹œ
                const messages = data.messages.reverse();

                messages.forEach(msg => {
                    this.displayHistoryMessage(msg);
                });

                // DOM ë Œë”ë§ ì™„ë£Œ í›„ ìŠ¤í¬ë¡¤ì„ ìµœí•˜ë‹¨ìœ¼ë¡œ ì´ë™
                requestAnimationFrame(() => {
                    const container = document.getElementById(`messages${this.id}`);
                    container.scrollTop = container.scrollHeight;
                    log(`${this.id}: ìŠ¤í¬ë¡¤ì„ ìµœí•˜ë‹¨ìœ¼ë¡œ ì´ë™ (scrollTop: ${container.scrollTop}, scrollHeight: ${container.scrollHeight})`);
                });

                // ë” ë§ì€ ë©”ì‹œì§€ê°€ ìˆìœ¼ë©´ ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ ê°€ëŠ¥
                if (data.hasNext) {
                    log(`${this.id}: ë” ë§ì€ ë©”ì‹œì§€ê°€ ìˆìŠµë‹ˆë‹¤ (nextCursor: ${data.nextCursorMillis})`);
                    // TODO: ìŠ¤í¬ë¡¤ ìƒë‹¨ ë„ë‹¬ ì‹œ ì´ì „ ë©”ì‹œì§€ ë¡œë“œ
                }

            } catch (error) {
                log(`${this.id}: ì±„íŒ… ë‚´ì—­ ë¡œë“œ ì‹¤íŒ¨ - ${error}`);
            }
        }

        displayHistoryMessage(data) {
            const container = document.getElementById(`messages${this.id}`);

            // ë‚ ì§œ êµ¬ë¶„ì„  ì¶”ê°€
            if (data.sentAt) {
                const messageDate = this.getDateString(data.sentAt);
                if (this.lastMessageDate !== messageDate) {
                    this.addDateSeparator(container, messageDate);
                    this.lastMessageDate = messageDate;
                }
            }

            // ë©”ì‹œì§€ í‘œì‹œ
            const div = document.createElement('div');

            // ë‚´ ë©”ì‹œì§€ì¸ì§€ í™•ì¸ (íƒ€ì… ë³€í™˜í•˜ì—¬ ë¹„êµ)
            const senderId = Number(data.senderId);
            const myUserId = Number(this.myUserId);
            const isMine = senderId === myUserId;
            log(`${this.id}: displayHistory - senderId: ${senderId} (íƒ€ì…: ${typeof senderId}), myUserId: ${myUserId} (íƒ€ì…: ${typeof myUserId}), isMine: ${isMine}`);

            div.className = isMine ? 'message mine' : 'message';

            // ì±„íŒ…ë°© ë©¤ë²„ ì •ë³´ì—ì„œ í”„ë¡œí•„ ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ê¸°
            let avatarContent = '';
            let senderProfileImage = null;

            if (this.currentRoom && this.currentRoom.chatMembers) {
                const member = this.currentRoom.chatMembers.find(m => m.userId === data.senderId);
                if (member) {
                    senderProfileImage = member.profileImageUrl;
                }
            }

            if (senderProfileImage) {
                avatarContent = `<img src="${senderProfileImage}" alt="${data.senderName || 'User'}" />`;
            } else {
                const initial = (data.senderName || data.senderId || 'U').toString().charAt(0).toUpperCase();
                avatarContent = initial;
            }

            const time = data.sentAt ? new Date(data.sentAt).toLocaleTimeString('ko-KR', {
                hour: '2-digit',
                minute: '2-digit'
            }) : '';

            div.innerHTML = `
                <div class="message-avatar">${avatarContent}</div>
                <div class="message-content">
                    <div class="message-sender">${data.senderName || (data.senderId ? `User ${data.senderId}` : '')}</div>
                    <div class="message-bubble">${this.escapeHtml(data.content || '')}</div>
                    <div class="message-time">${time}</div>
                </div>
            `;

            container.appendChild(div);
        }

        subscribeToRoom(roomId) {
            if (!this.stompClient || !this.stompClient.connected) {
                log(`${this.id}: WebSocketì´ ì—°ê²°ë˜ì§€ ì•ŠìŒ`);
                return;
            }

            this.subscription = this.stompClient.subscribe(
                `/sub/chat/rooms/${roomId}`,
                (message) => {
                    log(`${this.id}: RECV raw: ${message.body}`);

                    let data;
                    try {
                        data = JSON.parse(message.body);
                    } catch (e) {
                        data = { content: message.body };
                    }

                    this.displayMessage(data);
                }
            );

            log(`${this.id}: ì±„íŒ…ë°© ${roomId} êµ¬ë… ì‹œì‘`);
        }

        // isLocal: ë‚´ê°€ ì§€ê¸ˆ ë³´ë‚¸ ë©”ì‹œì§€(ë¡œì»¬ ì—ì½”)ì¸ì§€ ì—¬ë¶€
    displayMessage(data) {
        const container = document.getElementById(`messages${this.id}`);

        // ë‚ ì§œ êµ¬ë¶„ì„  ì¶”ê°€
        if (data.sentAt) {
            const messageDate = this.getDateString(data.sentAt);
            if (this.lastMessageDate !== messageDate) {
                this.addDateSeparator(container, messageDate);
                this.lastMessageDate = messageDate;
            }
        }

        const div = document.createElement('div');

        // ë‚´ ë©”ì‹œì§€ì¸ì§€ í™•ì¸ (íƒ€ì… ë³€í™˜í•˜ì—¬ ë¹„êµ)
        const senderId = Number(data.senderId);
        const myUserId = Number(this.myUserId);
        const isMine = senderId === myUserId;
        log(`${this.id}: displayMessage - senderId: ${senderId} (íƒ€ì…: ${typeof senderId}), myUserId: ${myUserId} (íƒ€ì…: ${typeof myUserId}), isMine: ${isMine}`);

        div.className = isMine ? 'message mine' : 'message';

        // ì±„íŒ…ë°© ë©¤ë²„ ì •ë³´ì—ì„œ í”„ë¡œí•„ ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ê¸°
        let avatarContent = '';
        let senderProfileImage = null;

        if (this.currentRoom && this.currentRoom.chatMembers) {
            const member = this.currentRoom.chatMembers.find(m => m.userId === data.senderId);
            if (member) {
                senderProfileImage = member.profileImageUrl;
            }
        }

        if (senderProfileImage) {
            avatarContent = `<img src="${senderProfileImage}" alt="${data.senderName || 'User'}" />`;
        } else {
            const initial = (data.senderName || data.senderId || 'U').toString().charAt(0).toUpperCase();
            avatarContent = initial;
        }

        const time = data.sentAt ? new Date(data.sentAt).toLocaleTimeString('ko-KR', {
            hour: '2-digit',
            minute: '2-digit'
        }) : '';

        div.innerHTML = `
            <div class="message-avatar">${avatarContent}</div>
            <div class="message-content">
                <div class="message-sender">${data.senderName || (data.senderId ? `User ${data.senderId}` : '')}</div>
                <div class="message-bubble">${this.escapeHtml(data.content || '')}</div>
                <div class="message-time">${time}</div>
            </div>
        `;

        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
    }

        sendMessage() {
            if (!this.stompClient || !this.stompClient.connected) {
                alert('WebSocketì´ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤');
                return;
            }

            if (!this.currentRoomId) {
                alert('ì±„íŒ…ë°©ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”');
                return;
            }

            const input = document.getElementById(`input${this.id}`);
            const content = input.value.trim();
            if (!content) return;

            const payload = {
                type: 'TALK',
                content: content
            };

            // 1) ì„œë²„ë¡œ ì „ì†¡
            this.stompClient.send(
                `/pub/chat/rooms/${this.currentRoomId}/send`,
                {},
                JSON.stringify(payload)
            );

            input.value = '';
            log(`${this.id}: ë©”ì‹œì§€ ì „ì†¡ - "${content}"`);
        }

        createRoom() {
            if (!this.token) {
                alert('ë¨¼ì € ë¡œê·¸ì¸í•˜ì„¸ìš”');
                return;
            }
            openCreateRoomModal(this);
        }

        async submitCreateRoom(title, memberIds, type, postId, imageFile) {
            try {
                let res;

                if (imageFile) {
                    // ì´ë¯¸ì§€ê°€ ìˆëŠ” ê²½ìš°: multipart/form-data
                    log(`${this.id}: ì´ë¯¸ì§€ í¬í•¨ ì±„íŒ…ë°© ìƒì„± (multipart/form-data)`);

                    const formData = new FormData();
                    const requestData = {
                        title: title,
                        memberIds: Array.from(memberIds),
                        type: type,
                        postId: postId || null
                    };

                    formData.append('request', new Blob([JSON.stringify(requestData)], {
                        type: 'application/json'
                    }));
                    formData.append('roomImage', imageFile);

                    res = await fetch(`${API_BASE}/api/chat/rooms`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${this.token}`
                        },
                        body: formData
                    });
                } else {
                    // ì´ë¯¸ì§€ê°€ ì—†ëŠ” ê²½ìš°: application/json
                    log(`${this.id}: ì´ë¯¸ì§€ ì—†ì´ ì±„íŒ…ë°© ìƒì„± (application/json)`);

                    res = await fetch(`${API_BASE}/api/chat/rooms`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${this.token}`
                        },
                        body: JSON.stringify({
                            title: title,
                            memberIds: Array.from(memberIds),
                            type: type,
                            postId: postId || null
                        })
                    });
                }

                if (!res.ok) {
                    const error = await res.text();
                    throw new Error(error);
                }

                const newRoom = await res.json();
                log(`${this.id}: ì±„íŒ…ë°© ìƒì„±ë¨ - ${newRoom.title} (ID: ${newRoom.roomId})`);

                await this.loadRooms();
                return newRoom;
            } catch (error) {
                log(`${this.id}: ì±„íŒ…ë°© ìƒì„± ì‹¤íŒ¨ - ${error}`);
                throw error;
            }
        }

        getSenderIdFromToken() {
            if (!this.token) return null;
            try {
                const base64Url = this.token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(c => {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                const payload = JSON.parse(jsonPayload);
                return payload.userId || payload.sub || payload.id;
            } catch (e) {
                return null;
            }
        }

        getDateString(dateString) {
            const date = new Date(dateString);
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);

            // ë‚ ì§œë¥¼ YYYY-MM-DD í˜•ì‹ìœ¼ë¡œ ë¹„êµ
            const dateStr = date.toISOString().split('T')[0];
            const todayStr = today.toISOString().split('T')[0];
            const yesterdayStr = yesterday.toISOString().split('T')[0];

            if (dateStr === todayStr) {
                return 'ì˜¤ëŠ˜';
            } else if (dateStr === yesterdayStr) {
                return 'ì–´ì œ';
            } else {
                // YYYYë…„ MMì›” DDì¼ í˜•ì‹
                const year = date.getFullYear();
                const month = date.getMonth() + 1;
                const day = date.getDate();
                return `${year}ë…„ ${month}ì›” ${day}ì¼`;
            }
        }

        addDateSeparator(container, dateText) {
            const separator = document.createElement('div');
            separator.className = 'date-separator';
            separator.innerHTML = `<div class="date-separator-text">${dateText}</div>`;
            container.appendChild(separator);
        }

        escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }
    }

    // í´ë¼ì´ì–¸íŠ¸ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
    const clientA = new ChatClient('A', 'A'); // ì™¼ìª½ í™”ë©´
    const clientB = new ChatClient('B', 'B'); // ì˜¤ë¥¸ìª½ í™”ë©´

    // ì—”í„°í‚¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    document.getElementById('inputA').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') clientA.sendMessage();
    });
    document.getElementById('inputB').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') clientB.sendMessage();
    });

    document.getElementById('tokenA').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') clientA.loginWithToken();
    });
    document.getElementById('tokenB').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') clientB.loginWithToken();
    });

    window.addEventListener('load', async () => {
        log('ì±„íŒ… í…ŒìŠ¤íŠ¸ í˜ì´ì§€ ë¡œë“œë¨');
        log('ìë™ ë¡œê·¸ì¸ ì‹œë„ ì¤‘...');

        await clientA.autoLogin();
        await clientB.autoLogin();
    });

    // === ì±„íŒ…ë°© ìƒì„± ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜ë“¤ ===
    let currentClient = null;
    const modalMemberIds = new Set();

    function openCreateRoomModal(client) {
        currentClient = client;
        modalMemberIds.clear();
        document.getElementById('createRoomForm').reset();
        document.getElementById('modalMemberIdsContainer').innerHTML = '';
        removeModalImage(new Event('click'));
        hideModalStatus();
        document.getElementById('createRoomModal').classList.add('show');
    }

    function closeCreateRoomModal() {
        document.getElementById('createRoomModal').classList.remove('show');
        currentClient = null;
    }

    function addModalMemberId() {
        const input = document.getElementById('modalMemberIdInput');
        const memberId = parseInt(input.value.trim());

        if (!memberId || isNaN(memberId)) {
            showModalStatus('ìœ íš¨í•œ ë©¤ë²„ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”', 'error');
            return;
        }

        if (modalMemberIds.has(memberId)) {
            showModalStatus('ì´ë¯¸ ì¶”ê°€ëœ ë©¤ë²„ì…ë‹ˆë‹¤', 'error');
            return;
        }

        modalMemberIds.add(memberId);
        input.value = '';
        renderModalMemberIds();
        hideModalStatus();
    }

    function renderModalMemberIds() {
        const container = document.getElementById('modalMemberIdsContainer');
        container.innerHTML = '';

        modalMemberIds.forEach(id => {
            const tag = document.createElement('div');
            tag.className = 'member-id-tag';
            tag.innerHTML = `
                ë©¤ë²„ ID: ${id}
                <span class="remove-tag" onclick="removeModalMemberId(${id})">Ã—</span>
            `;
            container.appendChild(tag);
        });
    }

    function removeModalMemberId(id) {
        modalMemberIds.delete(id);
        renderModalMemberIds();
    }

    function handleModalImageSelect(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            document.getElementById('modalPreviewImage').src = e.target.result;
            document.getElementById('modalImagePreview').classList.add('show');
            document.getElementById('modalImageUploadContainer').classList.add('has-image');
        };
        reader.readAsDataURL(file);
    }

    function removeModalImage(event) {
        event.stopPropagation();
        document.getElementById('modalRoomImage').value = '';
        document.getElementById('modalImagePreview').classList.remove('show');
        document.getElementById('modalImageUploadContainer').classList.remove('has-image');
    }

    function showModalStatus(message, type) {
        const statusEl = document.getElementById('modalStatus');
        statusEl.textContent = message;
        statusEl.className = `modal-status show ${type}`;
    }

    function hideModalStatus() {
        const statusEl = document.getElementById('modalStatus');
        statusEl.className = 'modal-status';
    }

    // í¼ ì œì¶œ ì´ë²¤íŠ¸
    document.getElementById('createRoomForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        if (!currentClient) {
            showModalStatus('ì˜¤ë¥˜: í´ë¼ì´ì–¸íŠ¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤', 'error');
            return;
        }

        const submitBtn = document.getElementById('modalSubmitBtn');
        submitBtn.disabled = true;

        try {
            hideModalStatus();

            const title = document.getElementById('modalRoomTitle').value.trim();
            const type = document.getElementById('modalRoomType').value;
            const postId = document.getElementById('modalPostId').value.trim();
            const imageFile = document.getElementById('modalRoomImage').files[0];

            if (!title) {
                showModalStatus('ì±„íŒ…ë°© ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”', 'error');
                return;
            }

            if (modalMemberIds.size === 0) {
                showModalStatus('ìµœì†Œ 1ëª…ì˜ ë©¤ë²„ë¥¼ ì¶”ê°€í•˜ì„¸ìš”', 'error');
                return;
            }

            showModalStatus('ì±„íŒ…ë°© ìƒì„± ì¤‘...', 'info');

            const result = await currentClient.submitCreateRoom(
                title,
                modalMemberIds,
                type,
                postId,
                imageFile
            );

            showModalStatus(`ì±„íŒ…ë°© "${result.title}"ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!`, 'success');

            setTimeout(() => {
                closeCreateRoomModal();
            }, 1500);

        } catch (error) {
            showModalStatus('ì±„íŒ…ë°© ìƒì„± ì‹¤íŒ¨: ' + error.message, 'error');
        } finally {
            submitBtn.disabled = false;
        }
    });

    // Enter í‚¤ë¡œ ë©¤ë²„ ID ì¶”ê°€
    document.getElementById('modalMemberIdInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            addModalMemberId();
        }
    });

    // ëª¨ë‹¬ ì˜¤ë²„ë ˆì´ í´ë¦­ ì‹œ ë‹«ê¸°
    document.getElementById('createRoomModal').addEventListener('click', (e) => {
        if (e.target.id === 'createRoomModal') {
            closeCreateRoomModal();
        }
    });
</script>

</body>
</html>